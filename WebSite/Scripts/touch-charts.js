/*!
* Data Aquarium Framework - Charts for Touch UI
* Copyright 2008-2016 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function e(n){return n.match(/pie|donut/i)}function n(n,t,i,r){i||(i="visualization");r||(r="1");var f=i+r+(typeof n=="string"?n:n.join("-")),u=s[f];u&&u.loaded?t():u&&!u.loaded?u.callbacks.push(t):($app.touch.busyIndicator(!0),u=s[f]={loaded:!1,callbacks:[t]},google.load(i,r,{packages:n,callback:function(){$app.touch.busyIndicator(!1);u.loaded=!0;$(u.callbacks).each(function(){this()})}}))}function c(t,i){var u=$('<div class="app-chart-headerbar"><\/div>').appendTo(i),e=$('<div class="app-chart-mini"><\/div>').appendTo(u).attr("title",r.ShowChart),s=t.Properties.title||t.Title,a=$('<span class="app-chart-header"><\/span>').appendTo(u),f=$('<div class="app-chart-data app-scrollable"><\/div>').appendTo(i),h=$("<table><\/table>").appendTo(f),c=!t.ChartType.match(/map|table/);c||e.hide();i.closest(".app-chart").addClass("app-chart-has-data");t.ShowData=!0;n("corechart",function(){var r=google.visualization.arrayToDataTable(t.ChartData),p=r.getNumberOfRows(),y=r.getNumberOfColumns(),v=$("<tr><\/tr>").appendTo(h),u,i,n,f;for(a.text(s.substring(0,1).toUpperCase()+s.substring(1)),l(t,r),i=0;i<y;i++)n=r.getColumnLabel(i),f=$("<th><\/th>").appendTo(v),n!=null&&f.text(n).attr("title",n);for(u=0;u<p;u++)for(v=$("<tr><\/tr>").appendTo(h),i=0;i<y;i++)n=r.getFormattedValue(u,i),f=$("<td><\/td>").appendTo(v),n!=null&&f.text(n=="0"?"":n).attr("title",n);c&&o(t,e)});f.height(Math.floor(i.height()-u.outerHeight(!0)));f.width(i.width())}function o(n,t){var i=a[n.ChartType];i&&i(n,t)}function t(n,t,i){var u=e(n.ChartType),h=n.Properties.title||n.Title,o,r,f,s;i||(i={});i.legend||(i.legend={});i.hAxis||(i.hAxis={});i.vAxis||(i.vAxis={});i.chartArea||(i.chartArea={});i.tooltip||(i.tooltip={});i.title=h.charAt(0).toUpperCase()+h.slice(1);i.width=Math.floor(t.width())-1;i.height=Math.floor(t.height())-1;i.tooltip.trigger="focus";n.ChartData[0].length<=2&&(u||(i.legend.position="none"),u&&(n.Properties.maximize=!0));u&&(i.sliceVisibilityThreshold=0);for(o in n.Properties)if(n.Properties.hasOwnProperty(o)){r=n.Properties[o];switch(o){case"crosshair":i.crosshair={orientation:r==0?"both":r,trigger:"both"};break;case"maximize":u?(i.chartArea.top="15%",i.chartArea.width="80%",i.chartArea.height="80%"):(i.titlePosition="in",i.chartArea.width="100%",i.chartArea.height="100%",i.legend.position||(i.legend.position="in"));i.axisTitlesPosition="in";i.hAxis.textPosition="in";i.vAxis.textPosition="in";break;case"haxistitle":i.hAxis.title=r;break;case"vaxistitle":i.vAxis.title=r;break;case"region":i.region=r;break;case"displaymode":i.displayMode=r;break;case"resolution":i.resolution=r;break;case"curve":i.curveType="function";break;case"explorer":i.explorer={};break;case"maptype":i.mapType=r;break;case"enablescrollwheel":i.enableScrollWheel=!0;break;case"usemaptypecontrol":i.useMapTypeControl=!0;break;case"pointshape":i.pointShape=r;break;case"pointsize":i.pointSize=r;break;case"orientation":i.orientation=r;break;case"animation":i.animation={startup:!0,duration:500,easing:"out"};break;case"colors":f=r.split(",");for(s in f)f[s]=f[s].trim();i.colors=f}}return n.ShowData&&(i.legend.position="none",i.axisTitlesPosition="none",i.height="100%",i.titlePosition="none",i.chartArea.top="0",i.chartArea.width="100%",i.chartArea.height="100%",i.enableInteractivity=!1),$("body").hasClass("app-theme-dark")&&(i.backgroundColor="#1f1f1f",i.hAxis.textStyle={color:"white"},i.hAxis.gridlines={color:"#000"},i.vAxis.textStyle={color:"white"},i.vAxis.gridlines={color:"#000"},i.legend.textStyle={color:"#999"},i.legend.scrollArrows={activeColor:"#fff",inactiveColor:"#777"},i.legend.pagingTextStyle={color:"#999"},i.titleTextStyle={color:"white"},u&&(i.pieSliceBorderColor="#111")),i}function l(n,t){var o=n.ValueFieldNames.length,c=n.ValueFieldNames.length,r;for(name in n.Formats){var i=n.Formats[name],u=/(\w+)(\d)/.exec(name),s=u[1],h=u[2],f=n.ValueFieldNames.indexOf(s,h),e;if(f!=-1&&i){switch(i.toLowerCase()){case"c":case"C":i="Â¤00.00";break;case"d":case"D":i="00.00";break;case"e":case"E":i="0.######E+000";break;case"f":case"F":i="00.00";break;case"n":case"N":i="00.00";break;case"p":case"P":i="%";break;case"x":case"X":i="00.00"}for(e=new google.visualization.NumberFormat({pattern:i}),r=f+1;r<n.Data[0].length;r=r+o)e.format(t,r)}}}function i(n,t,i,r){function o(){}var f=google.visualization.arrayToDataTable(n.ChartData),e=n.ChartType.match(/geo/i);l(n,f);u.desktop()||e||o();n.Properties.animation&&!e&&n.ChartType!="map"&&i.draw(null,r);i.draw(f,r);u.desktop()&&!e&&(google.visualization.events.addListener(i,"select",function(){if(r.tooltip.trigger=="focus"){r.tooltip.trigger="selection";var n=i.getSelection();return o(),i.draw(f,r),i.setSelection(n),!1}}),google.visualization.events.addListener(i,"click",function(n){n.targetID.match(/^action/)||r.tooltip.trigger!="selection"||(r.tooltip.trigger="focus",i.removeAction("filter"),i.removeAction("exclude"),i.setSelection(null),i.draw(f,r))}))}var v=$(window),y=$.mobile,u=$app.touch,s={},r=Web.DataViewResources.Presenters.Charts,f=Web.DataViewResources.Mobile,h,a;$(document).on("resizing.app",function(){$.mobile.activePage.find(".app-chart-inner").children().hide()}).on("searching.app",function(n){var t=n.dataView._id;$("#"+t+'.ui-page .app-wrapper > [data-presenter="Charts"] .app-chart-inner, .app-echo[data-for="'+t+'"] .app-chart-inner').children().hide()}).on("vclick",".app-chart",function(n){function w(){delete e.ShowData;i.viewProp("chartsConfig",l);var r=t.closest(".app-chart-list").parent().data("pivots")["pivot"+p],n=t.closest(".app-chart").find(".app-chart-inner");n.empty();n.closest(".app-chart").removeClass("app-chart-has-data");r.ShowData=!1;o(r,n)}var t=$(n.target),b=t.closest(".app-echo"),i=b.length?$app.find(b.attr("data-for")):u.dataView(),h=t.closest(".app-chart").data("data-context");if(i&&h){var p=h.Id,l=i.viewProp("chartsConfig"),e=l&&l[p],v=!$("body").hasClass("app-sidebar-undocked"),y=$(window).width()/parseFloat($("body").css("font-size")),k=v&&y>=50||!v&&y>=40,d=v&&y>=85||!v&&y>=62,a=e.size?e.size:"small",s=[];return t.is(".app-btn-more")&&!$app.mobile.busy()?($app.mobile.callWithFeedback(t.closest(".ui-btn"),function(){a!="large"||d||(a="medium");a!="medium"||k||(a="small");var n=t.closest(".app-chart-list").parent().data("pivots")["pivot"+p];n.ChartType.match(/map|table/)||(e.ShowData?s.push({text:r.ShowChart,icon:"chart",callback:w}):s.push({text:r.ShowData,icon:"grid",callback:function(){e.ShowData=!0;i.viewProp("chartsConfig",l);var r=t.closest(".app-chart").find(".app-chart-inner");r.empty();c(n,r)}}));t.closest(".app-chart-list").find(".app-chart").length>1?(s.push({text:r.Sizes.Label}),s.push({text:r.Sizes.Small,icon:a=="small"?"check":"",callback:function(){delete e.size;e.resized=!0;i.viewProp("chartsConfig",l);$app.touch.presenter("show",{name:"Charts",id:i._id,container:t.closest(".app-wrapper")})}}),k&&s.push({text:r.Sizes.Medium,icon:a=="medium"?"check":"",callback:function(){e.size="medium";e.resized=!0;i.viewProp("chartsConfig",l);$app.touch.presenter("show",{name:"Charts",id:i._id,container:t.closest(".app-wrapper")})}}),d&&s.push({text:r.Sizes.Large,icon:a=="large"?"check":"",callback:function(){e.size="large";e.resized=!0;i.viewProp("chartsConfig",l);$app.touch.presenter("show",{name:"Charts",id:i._id,container:t.closest(".app-wrapper")})}})):s.push({text:r.Sizes.Auto,icon:"check",callback:function(){}});s.push({text:f.Filter});h.ColumnFieldNames&&h.ColumnFieldNames.length&&s.push({text:i.findField(h.ColumnFieldNames[0]).HeaderText,icon:"filter",callback:function(){u.configureFilter({field:h.ColumnFieldNames[0],scope:i._id,mode:"field"})}});h.RowFieldNames&&h.RowFieldNames.length&&s.push({text:i.findField(h.RowFieldNames[0]).HeaderText,icon:"filter",callback:function(){u.configureFilter({field:h.RowFieldNames[0],scope:i._id,mode:"field"})}});u.listPopup({anchor:t.closest("a"),iconPos:"right",items:s})}),!1):t.closest(".app-chart-mini").length?(w(),!1):void 0}}).on("taphold",".app-chart",function(n){var t=$(n.target);t.is("td")&&t.closest(".app-chart-data").length&&u.listPopup({anchor:t,title:t.text()})});a={area:function(r,u){n("corechart",function(){var n=t(r,u),f=new google.visualization.AreaChart($(u).get(0));i(r,u,f,n)})},areastacked:function(r,u){n("corechart",function(){var n=t(r,u,{isStacked:!0}),f=new google.visualization.AreaChart($(u).get(0));i(r,u,f,n)})},bar:function(r,u){n("corechart",function(){var n=t(r,u),f=new google.visualization.BarChart($(u).get(0));i(r,u,f,n)})},barstacked:function(r,u){n("corechart",function(){var n=t(r,u,{isStacked:!0}),f=new google.visualization.BarChart($(u).get(0));i(r,u,f,n)})},column:function(r,u){n("corechart",function(){var n=t(r,u),f=new google.visualization.ColumnChart($(u).get(0));i(r,u,f,n)})},columnstacked:function(r,u){n("corechart",function(){var n=t(r,u,{isStacked:!0}),f=new google.visualization.ColumnChart($(u).get(0));i(r,u,f,n)})},candlestick:function(r,u){n("corechart",function(){var n=t(r,u),f=new google.visualization.CandlestickChart($(u).get(0));i(r,u,f,n)})},donut:function(r,u){n("corechart",function(){var n=t(r,u,{pieHole:.4,backgroundColor:"transparent"}),f=new google.visualization.PieChart($(u).get(0));i(r,u,f,n)})},geo:function(r,u){n("geochart",function(){var n=t(r,u,{backgroundColor:"transparent"}),f=new google.visualization.GeoChart($(u).get(0));i(r,u,f,n)})},map:function(r,u){n("map",function(){var n=t(r,u,{showTip:!0}),f=new google.visualization.Map($(u).get(0));i(r,u,f,n)})},line:function(r,u){n("corechart",function(){var n=t(r,u,{showTip:!0}),f=new google.visualization.LineChart($(u).get(0));i(r,u,f,n)})},pie:function(r,u){n("corechart",function(){var n=t(r,u,{title:r.Title,backgroundColor:"transparent"}),f=new google.visualization.PieChart($(u).get(0));i(r,u,f,n)})},pie3d:function(r,u){n("corechart",function(){var n=t(r,u,{backgroundColor:"transparent",is3D:!0}),f=new google.visualization.PieChart($(u).get(0));i(r,u,f,n)})},scatter:function(r,u){n("corechart",function(){var n=t(r,u),f=new google.visualization.ScatterChart($(u).get(0));i(r,u,f,n)})},table:function(r,u){n("table",function(){var n=t(r,u),f=new google.visualization.Table($(u).get(0));i(r,u,f,n)})}};$app.touch.presenter("register",{name:"Charts",icon:function(){return"chart"},text:function(){return r.Text},supports:function(n){var u=!1;if($(n._fields).each(function(){if(this.Tag&&this.Tag.indexOf("pivot")!=-1)return u=!0,!1}),u)n.AutoPivots=null;else{if(n.AutoPivots&&$.isEmptyObject(n.AutoPivots))return!0;var t=1,g=n._fields[0].Label,i=[],o=0,v=0,h=["pie3d","column","donut","bar"],r=[],f=0,y=0,c=["line","column","area"],p=0,l=["columnstacked-top5","area-top7","column-top5","barstacked-top5"],w=[],a=n.groupExpression(),b=!1;n.AutoPivots={};function s(){return h[v++%h.length]}function k(){return c[y++%c.length]}function d(){return l[p++%l.length]}$(n._fields).each(function(){var u=this;n.AutoPivots[u.Name]=[];(u.ItemsDataController||u.AliasName)&&i.push(u.Name);u.Type=="DateTime"&&r.push(u.Name);u.DataFormatString=="c"&&w.push(u.Name);a&&a[0]==(u.AliasName||u.Name)&&n.AutoPivots[u.Name].push("pivot"+t+++"-row1-top10-sortdescbyvalue-"+(u.Type=="String"?"pie-other":"column"))});$(i).each(function(){if(t>9||!r[f])return!1;var u=this,e=r[f];n.AutoPivots[i[o++%i.length]].push("pivot"+t+"-col1-sortdescbyvalue-"+d());n.AutoPivots[r[f++%r.length]].push("pivot"+t+++"-row1-date-all-hideblank")});o=0;f=0;$(n._fields).each(function(){var u,r,f,h;if(t>9)return!1;if(u=this,r=u.Name,u.IsPrimaryKey)return!0;(u.ItemsDataController||u.AliasName)&&n.AutoPivots[r].push("pivot"+t+++"-row1-top10-other-sortdescbyvalue-"+s());switch(u.Type){case"Int16":case"Int32":case"Int64":case"Single":case"Double":case"Decimal":if(i.length!=0&&!(u.ItemsDataController||u.AliasName)){if(f="sum",h=s(),r.match(/salary/i))f="avg";else if(r.match(/total/i))f="sum";else if(u.DataFormatString=="{0:c}"||r.match(/price|discount/i))for(f="avg";e(h);)h=s();e(h)&&(f="sum");n.AutoPivots[r].push("pivot"+t+"-val1-"+f+"-"+h);n.AutoPivots[i[o++%i.length]].push("pivot"+t+++"-row1-top7-other-sortdescbyvalue")}break;case"DateTime":r.match(/birth|hire/i)?n.AutoPivots[r].push("pivot"+t+++"-row1-month-all-pie3d"):n.AutoPivots[r].push("pivot"+t+++"-row1-"+k()+"-date-all-hideblank");break;case"String":b||r.match(/country/i)&&n.AutoPivots[r].push("pivot"+t+++"-row1-geo")}});t>1&&(u=!0)}return u},show:function(n){function a(n){var u,e,o,s,h;v();u=$('<ul class="app-listview app-grid"/>').appendTo(i);n?(s=$('<li data-icon="filter" class="ui-last-child"><a href="#app-filter" class="ui-btn ui-icon-filter ui-btn-icon-left"><p/><\/a><\/li>').appendTo(u).find("a"),h=String.format(r.DataWarning,__settings.maxPivotRowCount),s.attr("title",f.Filter).find("p").text(h)):(e=$('<li data-icon="refresh"><a href="#app-refresh" class="ui-btn ui-icon-refresh ui-btn-icon-left"><p/><\/a><\/li>').appendTo(u).find("a"),e.attr("title",Web.DataViewResources.Pager.Refresh).find("p").text(Web.DataViewResources.Data.NoRecords),t._filter&&t._filter.length&&!t.filterIsExternal()&&(o=$('<li data-icon="filter" class="ui-last-child"><a href="#app-clear-filter" class="ui-btn ui-icon-filter ui-btn-icon-left"><p/><\/a><\/li>').appendTo(u).find("a"),o.attr("title",f.ClearFilter).find("p").text(f.ClearFilter)));u.listview()}function v(){i.find(".app-chart").each(function(){$(this).removeData()});i.empty()}function p(n){for(pivot in n)$(n[pivot].Data).each(function(){for(var t=this,n=0;n<t.length;)t[n]=y(t[n]),n++}),n[pivot].Title=y(n[pivot].Title),n[pivot].ChartData=JSON.parse(JSON.stringify(n[pivot].Data)),$(n[pivot].ChartData).each(function(){for(var i=this,t=this,n=0,n=0;n<t.length;n++)t[n]==null&&(t[n]=0)})}function y(n){if(!n||!isNaN(n)||isFinite(n))return n;var i=n.match(/\$(\S+)/g);return $(i).each(function(){var f=this.replace(/\d*/g,""),i=f.replace(/[$\d]*/g,""),u=r.ChartLabels[i];u?(i.match(/Quarter|Week/)&&(u=u.substring(0,1)),n=n.replace(f,u)):i=="CurrentViewLabel"&&(n=n.replace(f,t._view.Label));i=="Other"&&(n.isOther=!0)}),n}function l(){var p,l,h,n,k,tt=[],ft=0,w=i.closest(".app-wrapper"),it,y=0,nt=1,d,et=i.find(".app-chart"),rt,ut,g=!1,st,b,f;et.length>0&&(st=w.scrollTop(),$(et).each(function(){var n=$(this);if(n.position().top>0)return s[n.data("data-context").Id].lastScrollPosition=!0,!1}));v();$('<div class="app-chart"><span class="app-chart-inner"/><\/div><div class="app-chart"><span class="app-chart-inner"/><\/div><div class="app-chart"><span class="app-chart-inner"/><\/div>').appendTo(i);d=i.find(".app-chart");$(d[0]).offset().left<$(d[1]).offset().left&&nt++;$(d[1]).offset().left<$(d[2]).offset().left&&nt++;d.remove();i.empty();for(k in e)if(n=e[k],n.ChartType&&n.RecordCount!=0)g||(n.Properties.medium||n.Properties.large?g=!0:s&&(f=s[n.Id],f&&f.size&&f.size.match(/medium|large/)&&(g=!0))),y++;else continue;y==1&&(g=!0);for(k in e)(n=e[k],placeholder=$('<div class="app-chart"><\/div>').data("data-context",n),inner=$('<span class="app-chart-inner"><\/span>').appendTo(placeholder),moreBtn=$('<a class="ui-btn"><span class="app-btn-more">&nbsp;<\/span><\/a>').appendTo(placeholder).attr("title",r.More),n.ChartType&&n.RecordCount!=0)&&(placeholder.appendTo(i),p||(h=w.height(),it=w.find(".app-presenter-instruction:visible"),it.length&&(h-=it.outerHeight()),h=Math.floor(h),p=inner.width(),l=nt==3?y<=3?Math.min(h,p*1.33):Math.min(p*.66,Math.max(h/3,p*.5))-1:nt==2?y<=4?Math.max(h/2,p*.5):p*.66:h*.66,g&&y<=3&&(l=h*.5),l>h&&(l=p*.66,l>h&&(l=h)),l=Math.floor(l)),b=l,f=s[n.Id],f||(f=s[n.Id]={}),f.size||(n.Properties.small!=null?delete f.size:n.Properties.medium!=null?f.size="medium":n.Properties.large!=null&&(f.size="large")),f.size&&(f.size=="medium"?(y>2&&(b=l*2+1),placeholder.addClass("app-chart-medium")):f.size=="large"&&(b=h,placeholder.addClass("app-chart-large"))),y==1&&(placeholder.addClass("app-chart-large"),b=h),f.resized?(rt=placeholder,delete f.resized):f.lastScrollPosition&&(ut=placeholder,delete f.lastScrollPosition),f.ShowData||n.ChartType=="table"?n.ShowData=!0:n.ShowData&&(n.ShowData=!1),b<150&&(b=150),tt.push(inner.height(b)));if($('<div class="app-clear-fix"><\/div>').appendTo(i),setTimeout(function(){for(k in e)(n=e[k],n.ChartType&&n.RecordCount!=0)&&(n.ShowData?c(n,$(tt[ft++])):o(n,tt[ft++]))},10),u.syncEmbeddedViews(w),y==0&&a(!1),i.closest(".app-echo").length==0&&$('<div class="app-promo-filler"><\/div>').appendTo(i),t.viewProp("chartsConfig",s),y>1&&(rt||ut)){var ot=rt||ut,ht=ot.outerHeight(),ct=(w.height()-ht)/2,lt=ot.offset().top-w.offset().top-ct;u.scroll(w,lt)}}var w=this,t=$app.find(n.id),b=t._filter,i=n.container.find(".app-chart-list"),e=n.container.data("pivots"),s=t.viewProp("chartsConfig")||{};if(i.length==0&&(i=$('<div class="app-chart-list"><\/div>').appendTo(n.container)),(n.reset||e&&t.dataSignature()!=n.container.data("signature"))&&(e=null),t._totalRowCount>__settings.maxPivotRowCount){a(!0);return}e&&e.length!=0?l():(i.find(".app-chart-inner").children().hide(),$app.execute({controller:t._controller,command:"Pivot",pivotDefinitions:t.AutoPivots,view:t._viewId,_filter:t.combinedFilter(),sort:"",tags:t.get_tags(),success:function(i){e=i.Pivots;p(e);n.container.data("signature",t.dataSignature());n.container.data("pivots",e);h?l():u.registerAPI("Charts",function(){h=!0;l()})},error:function(n){$app.alert(String.format("{0}\n{1}",n.get_message(),n.get_stackTrace()))}}))},hide:function(){},dispose:function(n){n.container.removeData("pivots signature");n.container.find("app-chart").each(function(){$(this).removeData()})}})})(),function(){function uu(){return navigator.platform.match(/Win\d+|Mac/i)!=null&&(!navigator.maxTouchPoints||navigator.maxTouchPoints==0)}function nt(n){return n&&typeof n!="string"&&!(isNaN(+n)||n<new Date(1753,0)||n>new Date(9999,0))}function tt(n){navigator.vibrate&&(n||(n=50),navigator.vibrate(n))}function b(n){$('<div class="app-clear-fix"><\/div>').appendTo(n)}function fu(){if(!fr){var n=new Date;fr=setTimeout(function(){hr=setInterval(s,6e4)},(60-n.getSeconds())*1e3)}}function s(t,i,r){var b,e;if(t||!$(".app-calendar.app-has-time-prompt").length){var u=t||new Date,h=f(u),v=$(".app-calendar-time"),o,c=v.find("div.app-current-time"),k=l-l/25,d=u.getTime(),y=u.getMinutes(),g=new Date(u.getFullYear(),u.getMonth(),u.getDate()).getTime(),nt=d-g,a=v.find("li span"),p=u.getMinutes(),w=15e3/l;return i&&y!=0&&(h=":"+y),i?i=="week"?($(".app-calendar").addClass("app-has-time-prompt"),o=vt.activePage.find(".app-calendar-weekview .current-time-line")):o=$(".app-calendar-dayview .current-time-line"):o=$(".app-calendar-weekview .current-time-line, .app-calendar-dayview .current-time-line"),b=nt/864e5,e=k*b,i=="find"?s():c.first().css("top")!=e+"px"&&n.callInAnimationFrame(function(){h!=""&&(a.removeClass("time-hidden"),p<w?a.filter('span[data-cal-hour="'+u.getHours()+'"]').addClass("time-hidden"):p>60-w&&a.filter('span[data-cal-hour="'+(u.getHours()+1)+'"]').addClass("time-hidden"),c.text(h));c.css("top",e);o.css("top",e).data("date",u);r&&r(e)}),e}}function f(n,t,r){if(!n)return"";var u=n.getHours(),f=n.getMinutes(),h=n.getSeconds(),o=i.PMDesignator,s=i.AMDesignator,e=u<12?r?"":s:r?o.substring(0,1):o;return u>12&&(s||o)&&(u=u-12),t&&u<10&&u!=0&&(u="0"+u),u==0&&(u=o||s?12:0),f<10&&(f="0"+f),!r&&e&&(e=" "+e),r&&f=="00"?String.format("{0}{1}",u,e):String.format("{0}:{1}{2}",u,f,e)}function ci(n,t,i){i<.125?n.setHours(t):i<.375?n.setHours(t,15):i<.625?n.setHours(t,30):i<.875?n.setHours(t,45):n.setHours(t,60)}function k(n){return n.getDate()==w.getDate()&&n.getMonth()==gr&&n.getFullYear()==dr}function li(n,t){return n.getDate()==t.getDate()&&n.getMonth()==t.getMonth()&&n.getFullYear()==t.getFullYear()}function it(n){var t;return n.each(function(){return t=$(this),firstLeft=t.position().left,firstLeft>0||firstLeft*-1<t.width()/2?!1:void 0}),t}function ht(n,t,i,r,u,f){var e=n.combinedFilter().filter(function(n){var i=n.split(":")[0];return!i.startsWith(t.Name)&&(f==null||f.indexOf(i)==-1)}),o=n.convertFieldValueToString(t,r),s=u&&n.convertFieldValueToString(t,u),h;return(h=r==null?String.format("{0}:<{1}",t.Name,s):u==null?String.format("{0}:>={1}",t.Name,o):String.format("{0}:$between${1}$and${2}",t.Name,o,s),r&&isNaN(r.getTime())||u&&isNaN(u.getTime()))?(console&&console.log&&console.log("Error forming date filter: Date is NaN"),e):(e.push(h),e)}function t(n){var r=n.attr("data-cal-year"),t=n.attr("data-cal-month"),i=n.attr("data-cal-day");return new Date(r,t?t:0,i?i:1)}function ct(n,t){var i=n.attr("data-cal-h"),r=n.attr("data-cal-m"),u=n.attr("data-cal-s"),f=n.attr("data-cal-ms");t.setHours(i,r,u,f)}function lt(n,t){n.attr("data-cal-h",t.getHours()).attr("data-cal-m",t.getMinutes()).attr("data-cal-s",t.getSeconds()).attr("data-cal-ms",t.getMilliseconds())}function d(n,t){n.attr("data-cal-year",t.getFullYear()).attr("data-cal-month",t.getMonth()).attr("data-cal-day",t.getDate())}function eu(n){var t={hour:n.getHours(),minute:n.getMinutes(),ampm:""},r=!!i.AMDesignator.length;return r&&(t.ampm=t.hour>=12?i.PMDesignator:i.AMDesignator,t.hour>12&&(t.hour-=12),t.hour==0&&(t.hour=12)),t.hour=t.hour<10?" "+t.hour:t.hour.toString(),t.minute=t.minute<10?"0"+t.minute:t.minute.toString(),t}function vr(n,t,i){var o="",r=new Date(n,t,1),s=e[r.getDay()],h=new Date(n,t+1,1),l=e[h.getDay()],u="",c=0,a=0,f;for(l!=0&&h.setDate(h.getDate()+(6-l)+1),s!=0&&r.setDate(r.getDate()-s);a<42;)if(s=e[r.getDay()],s==0&&(u&&(o+=u+"<\/tr>"),c++,u="<tr>"),u+="<td",f=r.getMonth(),f==t||i?(i&&f!=t?u+=t==11&&f==0||!(t==0&&f==11||f<t)?' class="app-next-month"':' class="app-prev-month"':et.setHours(0,0,0,0)==r.setHours(0,0,0,0)&&(u+=' class="app-current-day"'),i&&(u+=String.format(' data-cal-year="{0}" data-cal-month="{1}" data-cal-day="{2}"',r.getFullYear(),r.getMonth(),r.getDate())),u+=String.format(">{0}",r.getDate())):u+=">&nbsp;",u+="<\/td>",r.setDate(r.getDate()+1),a++,!i&&r>=h)break;for(o+=u;c<6;)c++,o+="<tr><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><td>&nbsp;<\/td><\/tr>";return o+""}function v(n,t){vt.activePage.find(".app-tabs .ui-btn").each(function(){var n=$(this);if(n.attr("data-text")==t.text())return n.trigger("vclick"),!1})}function rt(n,t){var r=n.find(".app-tabs a"),i;return r.each(function(){var n=$(this);if(n.attr("data-text")==t)return i=n,!1}),i}function vi(n){var o=n.get_hasParent(),s=n.get_filterFields(),e=[],t=[],i,r,u,f;return $(n._allFields).each(function(){var n=this,l,v,h;if(n.Tag)for(l=n.Tag.split(" "),v=l.length,h=0;h<v;h++){if(match=ir.exec(l[h]),match!=null){var y=match[1]?parseInt(match[1]):0,a=match[2],p=match[4],c=t[y];if(a=="disabled")break;c||(t[y]=c={});switch(a){case"date":c.date=n;break;default:c[a]=!p?n:p}}ir.lastIndex=0}if((n.ItemsDataController||n.AliasName)&&n.ItemsStyle!="CheckBoxList"&&(o&&n.Name==s||(r?u||(u=n):r=n)),i||n.Type!="String"||(i=n),(n.Type=="DateTime"||n.Type=="Date")&&!n.tagged("calendar-disabled")){for(f||(f=n),h=0;e[h];)h++;e[h]={date:n,name:n.Label}}}),$.isEmptyObject(t)&&(t=e),$(t).each(function(){var t=this,e;!t.text&&i&&(t.text=i);!t.date&&f&&(t.date=f);t.name||(t.name=t.date.Label);r&&!t.color&&(t.color=i&&u&&i==r?u:r);e=t.color?n.viewProp("calendarColorMap-"+t.color.Name):null;t.colorMap=new tr(n,t,e)}),t}function ut(t,i){var f=n.dataView(),r=f&&f.calendar,l=f&&f.extension().viewStyle;t||(t=r.scrollable());var e=t.find('.app-presenter[data-presenter="calendar"]'),o=e.data("cal-header"),h=e.data("cal-footer"),c=r.viewClassName(),s=e.find(c);i&&(r.preventNavigate=!0,r.getViewHandler().resize(s,o,h,!0));pt&&pt();r.updateHeader(o);r.loadData(s);u("refresh",{container:n.sidebar().find(".app-calendar-plugin")})}function yr(n,t){return(t-n)/36e5*(l/25)}function pr(t){if(t.calendar)return!0;if(t._keyFields.length>1)return!1;var i=[],r=n.sidebar(),i=vi(t);return $.isEmptyObject(i)?!1:(t.calendar=new pi(t,i),t.calendarPlugin||(t.calendarPlugin=new nr(t,i)),!0)}function gt(n,t,i,r){n.css({transform:"",opacity:1}).addClass("app-scale");setTimeout(function(){n.one("transitionend",function(){return n.hide(),i&&i(),t.removeClass("app-scale").show().css({transform:"scale(0.75)",opacity:0}),setTimeout(function(){t.addClass("app-scale").css({transform:"scale(1)",opacity:1});t.one("transitionend",function(){t.removeClass("app-scale");r&&r()})}),!1}).css({transform:"scale(0.75)",opacity:0})})}function ni(n,t){return n.find(String.format('td[data-cal-month="{0}"][data-cal-day="{1}"]:not(.app-day-hidden)',t.getMonth(),t.getDate()))}function wr(t){t||(t=n.sidebar());t.find(".app-calendar-plugin").addClass("app-hide-request")}for(var ai,dt,yi,pi,wi,bi,ki,di,gi,h,u,nr,tr,br=$(window),at=$("body"),kr=at.hasClass("app-ios"),vt=$.mobile,n=$app.touch,o=Web.DataViewResources,ti=o.Pager,c=o.HeaderFilter,r=o.Presenters.Calendar,ft=o.Mobile,i=Sys.CultureInfo.CurrentCulture.dateTimeFormat,w=new Date,et=new Date(w.getFullYear(),w.getMonth(),w.getDate()),dr=w.getFullYear(),gr=w.getMonth(),ir=/calendar(\d+)?-([a-zA-Z]+)(:['"]?([a-zA-Z]+)['"]?)?(\d+)?/g,nu=/^(\d+), (\d+), (\d+)(, (.*))?$/,yt,rr,pt,ii,ri,wt,ur,fr,ui,er,or,sr,fi,hr,g,cr,bt=500,ei=100,ot=66,oi=0,l=1060,y={year:2,month:2,week:7,day:1,agenda:1},si={year:5,month:5,week:21,day:2,agenda:90},tu=30,kt=30,iu=23,lr=5,e=[],st=[],a,hi,ar='<a class="ui-btn app-month-picker" title="{0}, {1}">{2}, {3}<\/a>',ru='+{0} <span class="app-month-more">'+ft.More.toLowerCase()+"<\/span>",p=0;p<7;p++)e[p]=(7+p-i.FirstDayOfWeek)%7,st[p]=(p+i.FirstDayOfWeek)%7;ai=function(n){this.calendar=n;this.data={day:{},month:{},year:{},agenda:{}}};ai.prototype={select:function(n){var t=this.calendar.mode,u=new Date(n),i,r;if(t=="week")t="day";else if(t=="agenda")return this.data[t][n];return(r=this.data[t][u.getFullYear()],!r)?null:t=="year"?r:(i=r[u.getMonth()],!i)?null:t=="month"?i:i[u.getDate()]},insert:function(n,t){var a=new Date(n),v=this.dataView,y=this.calendar.activeCalendar.date,i=this.calendar.mode,l=i=="week"?7:1,f,c,h,o,e,r,u,s;if(i=="week")i="day";else if(i=="agenda"){n<0&&t.reverse();this.data[i][n]=t;return}switch(i){case"year":this.data[i][n.getFullYear()]={};break;case"month":r=this.data[i][n.getFullYear()];r||(r=this.data[i][n.getFullYear()]={});r[n.getMonth()]={};break;case"day":for(f=new Date(n),p=0;p<l;p++)r=this.data[i][f.getFullYear()],r||(r=this.data[i][f.getFullYear()]={}),u=r[f.getMonth()],u||(u=r[f.getMonth()]={}),u[f.getDate()]={rows:[],count:0},f.setDate(f.getDate()+1)}for(c in t)(h=t[c],o=nu.exec(h[0]),o)&&(e=new Date(o[1],parseInt(o[2])-1,o[3]||o[2]),r=this.data[i][e.getFullYear()],r||(r=this.data[i][e.getFullYear()]={}),u=r[e.getMonth()],u||(u=r[e.getMonth()]={}),s=u[e.getDate()],s||(s=u[e.getDate()]={rows:[],count:0}),i=="year"?s.count=h[1]:($(h[1]).each(function(){this.length==5&&s.rows.push(this)}),s.count+=h[2]))},clear:function(){this.data={day:{},month:{},year:{},agenda:{}}},clearAgenda:function(){this.data.agenda={}}};$(document).on("scrollstart.app",function(){yt=!0}).on("scroll.app scrollstop.app resized.app",function(t){var f;yt=!1;var i=n.dataView(),r=i&&i.calendar,s=i&&i.extension().viewStyle(),u=t.type=="resized";if(i&&s=="calendar"&&r){if(f=r.mode.match(/day|week/),u&&f){var h=r.scrollable(),c=h.find('div[data-presenter="calendar"]'),e=c.data("cal-header"),o=r.getVisibleView();o&&o.removeClass("app-has-current-day");e&&e.find(".app-week-header ul, .app-day-header ul").css("visibility","hidden")}clearTimeout(rr);rr=setTimeout(function(){yt||!u&&f||ut(t.relatedTarget,u)},300)}}).on("more.app",function(t){var p=$(t.target),f=p.closest(".app-echo"),u=f.length?$app.find(f.attr("data-for")):n.dataView(),e=$.mobile.activePage.find(".app-wrapper"),o=e.find(".app-calendar"),w=t.type=="more",b=t.type=="viewselector",s;if(u&&o.length&&o.is(":visible")&&(s=u.extension().viewStyle(),s=="calendar")){var k=u.viewProp("calendarConfig"),i=k.mode,d=e.parent().find(".app-bar-calendar .app-tabs"),h={text:r.Day,icon:i=="day"?"check":!1,callback:v},c={text:r.Week,icon:i=="week"?"check":!1,callback:v},l={text:r.Month,icon:i=="month"?"check":!1,callback:v},a={text:r.Year,icon:i=="year"?"check":!1,callback:v},y={text:r.Agenda,icon:i=="agenda"?"check":!1,callback:v};w&&t.panel[0].id=="app-panel-view-options"?t.items.splice(t.items.length,0,{},h,c,l,a,y):b&&d.css("visibility")=="hidden"&&t.items.splice(0,0,h,c,l,a,y,{})}}).on("vclick contextmenu taphold",".app-calendar, .app-bar-calendar",function(u){var ti,nr,kt,ot,vi,h,st,g,tt,d,it,ki,ht;if(a||hi){a=!1;return}var f=$(u.target),ei=u.type,pt=f.closest(".app-echo"),ct=pt.length?$app.find(pt.attr("data-for")):n.dataView(),e=ct.calendar,w=$.mobile.activePage.find(".app-wrapper"),ft=w.find('.app-presenter[data-presenter="calendar"]'),o=f.closest(".ui-btn"),wt=f.parent(),ni=f.attr("data-cal-hour"),di,sr=n.lastTouch();if(ct&&ct.calendar&&(di=ct._lookupInfo,!(f.closest(".app-tabs ul").length>0))){if(o.length||(o=f.find(".ui-btn")),f.is("ul")&&!!wt.attr("data-cal-day"))f=wt;else if(wt.is(".app-event"))f=wt;else if(f.is(".app-tabs")){return!1;var oi,gi}if((ei!="taphold"||f.is(".app-event"))&&(ei!="contextmenu"||f.is("td,.app-event")||ni!=null)){if(ti=f.data("data-context"),nr=f.data("data-more-context"),f.is(".dv-load-at-top, .dv-load-at-bottom, .app-btn-next, .app-btn-prev")){var nt=e.getBlocks(w),b,tt,bt=pt.length?0:si[e.mode],p=e.views[e.mode];if(f.is(".dv-load-at-top, .app-btn-prev")){nt.length>bt&&(e.mode=="agenda"?p.removeData(w.find(".app-calendar-agendaview"),p.maxPage):nt.slice(bt).remove());var et=nt.first(),k,ii=0,tt=Number(et.data("cal-year")),it=et.data("cal-month")!=null?Number(et.data("cal-month")):1,b=t(et),tr=w.scrollTop(),li=f.outerHeight(!0)-w.find(".app-presenter-instruction").outerHeight(!0),ai=[];for(ot=0;ot<y[e.mode];ot++){switch(e.mode){case"month":b.setMonth(b.getMonth()-1);k=p.drawMonth(b);break;case"year":b.setFullYear(tt-1);tt=b.getFullYear();k=p.drawYear(b);li+=-6;break;case"agenda":f.text(c.Loading);p.loadData(w.find(".app-calendar-agendaview"),null,p.minPage-1)}k&&(k.insertBefore(et),et=k,ai.push(k))}p.resize(e.getVisibleView());$(ai).each(function(){ii+=$(this).outerHeight(!0)});ii&&n.scroll(w,Math.ceil(tr+ii+li))}else{var lt=nt.last(),k,tt=Number(lt.data("cal-year")),it=lt.data("cal-month")!=null?Number(lt.data("cal-month")):1,b=new Date(tt,it);for(nt.length>bt&&(e.mode=="agenda"?p.removeData(w.find(".app-calendar-agendaview"),p.minPage):(nt.slice(0,nt.length-bt).remove(),kt=0,nt.each(function(){kt+=$(this).height()}),n.scroll(w,kt-1))),ot=0;ot<y[e.mode];ot++){switch(e.mode){case"month":b.setMonth(b.getMonth()+1);k=p.drawMonth(b);break;case"year":b.setFullYear(tt+1);tt=b.getFullYear();k=p.drawYear(b);break;case"agenda":f.text(c.Loading);p.loadData(w.find(".app-calendar-agendaview"),null,p.maxPage+1)}k&&(k.insertAfter(lt),lt=k)}p.resize(e.getVisibleView())}return!1}if(ti)return e.selectEvent(ti,f,u),u.preventDefault(),!1;if(f.is(".app-event-more")){if(!e.hasKeyFields())return!1;h=t(f.closest(".app-calendar-day"));vi=f.data("data-more-context");e.showEventList(h,vi,f,u)}else if(f.closest(".app-calendar-month-more").length){if(!e.hasKeyFields())return!1;var yi=f.closest(".app-calendar-month-more"),at=f.closest("td"),ir=at.find(".app-event"),pi=[],it=f.closest(".app-calendar-month"),d=at.attr("data-cal-day"),ri=t(it);ri.setDate(d);ir.each(function(){var n=$(this),t=n.data("data-context");pi.push(t[0])});function wi(n){n=n.filter(function(n){return pi.indexOf(n[0])==-1});e.showEventList(ri,n,f,u)}yi.addClass("ui-btn-active");n.callWithFeedback(at,function(){yi.removeClass("ui-btn-active");var n=at.data("data-more-context");n?wi(n):e.requestData({mode:"daylist",date:ri,success:function(t){t.Pivots.pivot0&&t.Pivots.pivot0.Data[1]&&(n=t.Pivots.pivot0.Data[1][1],at.data("data-more-context",n),wi(n))}})})}else{if(f.closest(".app-day-header").length){if(f.is("ul"))return;var ui=ft.find(".app-calendar-dayview"),st=o.closest(".app-day-header"),rr=ft.data("cal-footer");return n.callWithFeedback(o,function(){var f=ft.data("cal-footer").find(".app-scroll-outer"),r=o.closest("li"),n=t(r),s=n.getFullYear(),h=n.getMonth(),c=n.getDate(),i=e.getBlockByDate(ui,n,"day"),u=parseInt(ui.css("marginLeft"),10)-i.position().left;i.length&&e.views.day._scroll(ui,st,u*-1,rr,!0)}),!1}if(f.closest(".app-week-header").length)return f.is("ul")?void 0:(n.callWithFeedback(o,function(){var n=rt(f.closest(".app-bar-calendar"),r.Day),i=t(o.closest("li"));e.navigateDate=i;n&&n.trigger("vclick")}),!1);if(f.is(".ui-btn")||f.closest(".ui-btn").length){if(o.is(".app-calendar-today,.app-calendar-next,.app-calendar-prev"))return n.callWithFeedback(o,function(){if(w.length>0){var t=o.is(".app-calendar-next"),i=o.is(".app-calendar-prev"),n="today";t?n="next":i&&(n="prev");e.scrollView(n)}}),!1;if(o.is(".app-calendar-badge")){var dt=ct.viewProp("calendarConfig"),vt=dt.mode,ur=w.parent().find(".app-bar-calendar .app-tabs");ur.css("visibility")=="hidden"?n.callWithFeedback(o,function(){n.listPopup({anchor:o,iconPos:"left",items:[{text:r.Day,icon:vt=="day"?"check":!1,callback:v},{text:r.Week,icon:vt=="week"?"check":!1,callback:v},{text:r.Month,icon:vt=="month"?"check":!1,callback:v},{text:r.Year,icon:vt=="year"?"check":!1,callback:v},{text:r.Agenda,icon:vt=="agenda"?"check":!1,callback:v}]})}):n.callWithFeedback(o,function(){n.listPopup({anchor:o,title:o.attr("data-cal-value")})})}else if(o.is(".app-calendar-month-header")){st=ft.data("cal-header");g=rt(st,r.Month);switch(e.mode){case"year":tt=f.closest(".app-calendar-year").attr("data-cal-year");it=f.closest(".app-calendar-month").attr("data-cal-month");h=new Date(tt,it);break;case"agenda":h=t(o)}if(h)return e.navigateDate=h,n.callWithFeedback(o,function(){g&&g.trigger("vclick")}),!1}else if(o.parent().attr("data-cal-day")||f.is("h2")){if(e.mode=="month"){var it=f.closest(".app-calendar-month"),st=ft.data("cal-header"),g=rt(st,r.Day),h=t(it);return f.is("td")?void 0:(h.setDate(o.parent().attr("data-cal-day")),e.navigateDate=h,n.callWithFeedback(o,function(){g&&g.trigger("vclick")}),!1)}if(e.mode=="agenda"&&!pt.length){var h=t(f.closest("li")),st=ft.data("cal-header"),g=rt(st,r.Day);h&&(e.navigateDate=h,n.callWithFeedback(o,function(){g&&g.trigger("vclick")}))}}}else if(f.is("td")||f.is("div")&&ni!=null){if(e.mode=="year"){if(f.height()<20&&!uu())f.closest(".app-calendar-month").find(".app-calendar-month-header").trigger("vclick");else{if(d=parseInt(f.text()),!d)return;var tt=f.closest(".app-calendar-year").attr("data-cal-year"),it=f.closest(".app-calendar-month").attr("data-cal-month"),st=ft.data("cal-header"),g=rt(st,r.Day),h=new Date(tt,it,d);e.navigateDate=h;f.addClass("ui-btn-active");n.callWithFeedback(f,function(){g&&g.trigger("vclick");f.removeClass("ui-btn-active")})}return!1}var fi=e.getActionsByName("New"),h,ut,hr=$(".app-calendar"),dt=e.activeCalendar,gt=!!dt.end,bi=e.mode=="month",yt;if(!fi.length)return;if(bi){if(d=f.attr("data-cal-day"),it=f.closest("div.app-calendar-month"),!d)return;h=t(it);h.setDate(d);gt&&(ut=new Date(h),ut.setMinutes(ut.getMinutes()+60))}else{var d=f.closest("div.app-calendar-day"),fr=d.find(".app-calendar-eventlist"),er=u.clientY-f.offset().top,kt=f.height(),or=er/kt;h=t(d);ci(h,ni,or);gt&&(ut=new Date(h),ut.setMinutes(ut.getMinutes()+60));yt=e.drawEvent([null,h,ut,null," "],null).removeClass("app-event-color-0").addClass("app-event-new");gt&&yt.height(l/25);ki=s(h,"find");yt.css("top",ki+22).appendTo(fr)}return h?(fi.forEach(function(n){var t=n.callback;n.callback=function(n){$app.newValues=[{name:dt.date.Name,value:h}];gt&&$app.newValues.push({name:dt.end.Name,value:ut});t(n)}}),ht={iconPos:"left",items:fi,title:String.format("{0:"+i.LongDatePattern+"} {0:"+i.ShortTimePattern+"}",h),afterclose:function(){yt&&yt.remove()}},bi?ht.anchor=f:(ht.x=u.pageX,ht.y=u.pageY,ht.arrow="b,t,l,r"),n.listPopup(ht),!1):void 0}}}}}).on("clear.dataview.app",function(n){var t=n.dataView,i=t.calendar;i&&$("#"+t._id).find(".app-calendar-selected").removeClass("app-calendar-selected")}).on("reset.dataview.app",function(t){var i=t.dataView,f,e;if(i){var r=i.calendar,o=i&&i.extension()&&i.extension().viewStyle(),u=i.calendarPlugin;if(r&&(r.clear(),r.activeCalendar.colorMap.clearFilter()),u){if(f=i&&i.get_viewType(i._id),e=i.get_master(),e&&!i.get_selectedKey().length)return;f&&f=="Grid"&&(u.filtering||(u.clearCache(),n.stickyHeaderBar().hide()))}}}).on("show.dataview.app",function(t){var i=t.dataView,r=i&&i.get_viewType(i._id),u=n.sidebar();if(!i||r!="Grid"){wr(u);return}if(pr(i))r&&r=="Grid"&&(i.calendar&&i.calendar.loadData(i.calendar.getVisibleView()),i.calendarPlugin&&i.calendarPlugin.attach(u));else return});dt={options:{dataView:!0},start:function(n){var t,i;if(n.dir="horizontal",t=n.dataView.calendar,i=t.getViewHandler(),this._calendar=t,this._handler=i,i._scroll){var r=t.getVisibleView(),u=r.closest(".app-presenter"),f=u.data("cal-header").find(".app-"+t.mode+"-header"),e=u.data("cal-footer");this._calView=r;this._calHeader=f;this._calFooter=e.css("visibility","hidden");this._startMarginLeft=parseInt(r.css("margin-left"),10)}this._startX=n.x;this.scrollingAnimationFrame=null},move:function(n){var t=this;if(t._startMarginLeft!=null){var u=n.target,i=n.x-t._startX,r=t._startMarginLeft+i;t.scrollingAnimationCallback=function(){a=!0;t._handler._scroll(t._calView,t._calHeader,-r,t._calFooter);t.scrollingAnimationCallback!=null&&(t.scrollingAnimationFrame=requestAnimationFrame(t.scrollingAnimationCallback))};t.scrollingAnimationFrame==null&&(t.scrollingAnimationFrame=requestAnimationFrame(t.scrollingAnimationCallback))}},end:function(){this.scrollingAnimationCallback=null;this._calFooter&&this._calFooter.css("visibility","")},cancel:function(){this.scrollingAnimationCallback=null;this._calFooter&&this._calFooter.css("visibility","")}};$app.dragMan.calendar=dt;$app.dragMan["calendar-bar-week"]=dt;$app.dragMan["calendar-bar-day"]=dt;yi={options:{dataView:!0},start:function(t){var o;t.dir="all";var s=t.dataView,r=t.target,u=s.calendar,h=u.scrollable(),i=r.closest(".app-event"),c=r.is(".app-event-handle"),f=i.data("data-context"),e=i.position();f&&(this._element=i,this._oldHeight=i.outerHeight(),this._oldTop=e.top,this._context=f,this._startX=t.x,this._startY=t.y,this._mode="move",this._hasMoved=!1,this._hasScrolled=!1,u.mode.match(/day|week/)?(o=h.find(".app-presenter-instruction"),this._diffY=o.height()-e.top,c&&(this._mode="resize",this._diffY-=r.position().top,a=!0)):this._placeholder=$('<span style="display:none"><\/span>').insertAfter(i));n.stickyHeaderBar().hide().addClass("app-disabled")},move:function(i){var v,ot,ct,d,tt,b,it;at.css("pointer-events","");var rt=this,ut=i.dataView,o=ut&&ut.calendar,gt=i.target,h=$(i.dropTarget),ni=this._context[1],r=o.scrollable(),c=this._element;this._hasMoved||(this._hasMoved=!0,this._element.addClass("app-event-preview"));switch(o.mode){case"day":case"week":if(h=h.closest(".app-calendar-day,.current-time-line"),h.length){canDrag=!0;var u=h.is(".current-time-line")?h.data("date"):t(h),vt=i.y-this._startY-this._diffY,yt=l/25,a=vt/yt,ft=r.position();if(!ri){var k=i.x-ft.left-60,et=r.width()-k-60,pt=k<20||et<20;k<20?o.scrollView("prev"):et<20&&o.scrollView("next");pt&&(this._hasScrolled=!0,ri=setTimeout(function(){ri=null},1e3))}if(ii||(ii=setTimeout(function(){var t;ii=null;var f=r.scrollTop(),u=i.y-ft.top,e=r.height()-u;if(u<20){if(t=20-u,f<t)return;rt._diffY+=t;n.scroll(r,r.scrollTop()-t)}else if(e<20){if(t=20+e,f>=r[0].scrollHeight-r.height()-t)return;rt._diffY-=t;n.scroll(r,r.scrollTop()+t)}},20)),a>23.75?a=23.75:a<0&&(a=0),v=Math.floor(a),ot=a-v,v!=null&&(ci(u,v,ot),!this._previewDate||u.getTime()!=this._previewDate.getTime())){var wt=o.mode=="week"?"week":"find",bt=s(u,wt)+22,kt=o.getVisibleView(r),st=o.getBlockByDate(kt,u);if(st.length){var e=this._context[1],ht=this._context[2],y=new Date(e),p,w;y.setMinutes(y.getMinutes()+30);this._mode=="resize"?(u.setFullYear(e.getFullYear(),e.getMonth(),e.getDate()),u<y&&(u=y),p=f(e,!1)+" - "+f(u,!1),w=f(e,!1)+" - "+f(u,!1),c.css("height",yr(e.getTime(),u.getTime()))):(p=f(u,!1,!0),w=f(u),ht&&(ct=ht.getTime()-e.getTime(),d=new Date(u.getTime()+ct),p+=" - "+f(d,!1),w+=" - "+f(d,!1)),c.css("top",bt),c.appendTo(st.find(".app-calendar-eventlist")));c.find(".app-event-time").text(p);c.find(".app-event-time-long").text(w);this._previewDate=u}}}break;case"month":var g=h.closest("td"),dt=g.closest(".app-calendar-month"),nt=t(dt),lt=g.attr("data-cal-day");!lt||(nt.setDate(lt),tt=g.find("ul"),tt.length&&(!this._previewDate||nt.getTime()!=this._previewDate.getTime())&&(this._previewDate=nt,c.appendTo(tt)));b=i.y-r.position().top;it=r.height()-b;ui||(ui=setTimeout(function(){ui=null;var t=r.scrollTop();n.desktop()&&(b<20?n.scroll(r,r.scrollTop()-(20-b)):it<20&&n.scroll(r,r.scrollTop()+(20+it)))},20));break;case"year":case"agenda":return}},end:function(n){var ut=n.target,u=n.dataView,e=u&&u.calendar,tt=e.scrollable(),p,d,c,w,a,g,b,nt;if(u._keyFields.length){var k=e&&e.activeCalendar,v=this._context,r=v[1],i,y=v[2],f,o=$(n.dropTarget);switch(e.mode){case"day":case"week":if(o=o.closest(".app-calendar-day,.current-time-line"),o.length){i=o.is(".current-time-line")?o.data("date"):t(o);var it=n.y-this._startY-this._diffY,rt=l/25,h=it/rt;h>23.75?h=23.75:h<0&&(h=0);p=Math.floor(h);d=h-p;ci(i,p,d);this._mode=="resize"&&(i.setFullYear(r.getFullYear(),r.getMonth(),r.getDate()),f=i,i=r,c=new Date(r),c.setMinutes(c.getMinutes()+30),f<c&&(f=c))}break;case"month":w=$(event.target).closest("td");a=w.closest(".app-calendar-month");a.length&&(i=new Date(r),i.setYear(a.attr("data-cal-year")),i.setMonth(a.attr("data-cal-month")),i.setDate(w.attr("data-cal-day")),i.getDate()==r.getDate()&&i.getMonth()==r.getMonth()&&(i=null));this._placeholder.remove();break;case"year":case"agenda":return}i&&(g=u._keyFields[0].Name,b=[{field:g,value:v[0]},{field:k.date.Name,oldValue:r,newValue:i}],(y||f)&&(f||(nt=y.getTime()-r.getTime(),f=new Date(i.getTime()+nt)),b.push({field:k.end.Name,oldValue:y,newValue:f})),e.preventNavigate=!0,$app.execute({command:"Update",controller:u._controller,view:u._viewId,values:b,success:function(){e.lastScrollTop=tt.scrollTop();u.sync()},error:function(n){$app.alert(String.format("{0}",n.get_message()))}}));$(".app-calendar").removeClass("app-has-time-prompt");setTimeout(s,ei*2)}},cancel:function(t){var u=t.target,i=t.dataView.calendar,r;Math.abs(t.x-this._startX)<5&&u.trigger("vclick");this._hasMoved&&this._element.removeClass("app-event-preview");i.mode.match(/day|week/)?(r=i.getBlockByDate(i.getVisibleView(),this._context[1]),r.length?this._element.appendTo(r.find("ul")):this._element.remove()):(this._hasMoved&&this._element.insertAfter(this._placeholder),this._placeholder.remove());$(".app-calendar").removeClass("app-has-time-prompt");setTimeout(s,ei*2);this._element.css({height:this._oldHeight,top:this._oldTop});n.stickyHeaderBar().removeClass("app-disabled");i.preventNavigate=!0}};$app.dragMan["calendar-event"]=yi;$app.dragMan["calendar-event-handle"]=yi;pi=function(n,t){var i=this,r;i.dataView=n;r=n.viewProp("calendarConfig")||{};r.mode||(r.mode=$(document).width()<768?"day":"week");i.mode=r.mode;i.calendars=t;r.activeCalendar&&$(t).each(function(){if(this.name==r.activeCalendar)return i.activeCalendar=this,!1});i.activeCalendar||(i.activeCalendar=t[Object.keys(t)[0]]);i.cache=new ai(i);i.views={day:new wi(i),week:new bi(i),month:new ki(i),year:new di(i),agenda:new gi(i)};n.viewProp("calendarConfig",r)};pi.prototype={scrollable:function(){var t=this,n=t._scrollable;return n||(n=t._scrollable=$("#"+this.dataView._id+" .app-wrapper")),n},viewClassName:function(){return String.format(".app-calendar-{0}view",this.mode)},show:function(i){var u=this,s=this.dataView,et=s._filter,c=i.container.closest(".app-echo").length>0,l=i.container.find(".app-calendar"),y=i.container.closest(".app-wrapper"),ot=i.container.data("pivots"),d=this.calendars,p=s.viewProp("calendarConfig"),nt=this.activeCalendar.colorMap,f,tt,o,a,w,b,e,k,v,it;if(!$.isEmptyObject(d)){if(!c&&this.lastScrollTop&&y.scrollTop()==0&&n.scroll(y,this.lastScrollTop),c?(this.mode="agenda",this.echoMaxHeight=i.maxHeight,p.mode="agenda",s.viewProp("calendarConfig",p)):p.mode&&(this.mode=p.mode),w=this.getViewHandler(),this.navigateDate||this.preventNavigate||(b=s.extension().commandRow(),b&&this.activeCalendar.date?(this.enhancePrecision=!0,this.navigateDate=b[this.activeCalendar.date.Index]):this.navigateDate=new Date),l.length>0){if(e=i.container.find(".app-calendar > div:visible"),!c)if(f=i.container.data("cal-header"),o=i.container.data("cal-footer"),w.showHeaderAndFooter(f,o),$app.touch.bar("show",f),nt.show(),e.is(u.viewClassName())){if(this.navigateDate&&!this.preventNavigate){if(a=this.getBlockByDate(e,this.navigateDate),a&&a.length&&!c){this.scroll({view:e,enhancePrecision:!0});return}this.animate=!1}}else e.hide()}else if(l=$('<div class="app-calendar" data-draggable="calendar"><\/div>').appendTo(i.container),!c){f=$('<div class="app-bar-calendar"><\/div>').appendTo($app.touch.bar("create",{type:"header",page:i.container}));tt=$('<div class="app-calendar-badge ui-btn"><\/div>').appendTo(f);$app.touch.tabs("create",{container:$('<div class="app-tabs"><\/div>').appendTo(f),tabs:[{text:r.Day,value:"day",selected:this.mode=="day"},{text:r.Week,value:"week",selected:this.mode=="week"},{text:r.Month,value:"month",selected:this.mode=="month"},{text:r.Year,value:"year",selected:this.mode=="year"},{text:r.Agenda,value:"agenda",selected:this.mode=="agenda"}],change:function(r){var e=u.mode,c=u.getMostVisibleBlock(y,e),f=c&&t(c),o=!1,l=s.viewProp("calendarConfig"),a=s.calendarPlugin;if(l.mode=r.value,s.viewProp("calendarConfig",l),!u.navigateDate){if(u.lastDate)switch(e){case"year":u.lastDate.getFullYear()==f.getFullYear()&&(o=!0);break;case"month":u.lastDate.getFullYear()==f.getFullYear()&&u.lastDate.getMonth()==f.getMonth()&&(o=!0)}u.navigateDate=o?u.lastDate:f;u.enhancePrecision=!0}e.match(/week|day/)&&(u.lastDayScrollTop=y.scrollTop());i.container=i.container.closest(".app-wrapper");i.container.focus();u.navigateDate&&isNaN(u.navigateDate.getTime())&&(alert("navigate date is NaN"),u.navigateDate=new Date);n.presenter("show",i);h("refresh",{container:n.sidebar().find(".app-calendar-plugin")})},restoreScrolling:!1,stickyHeader:!0});i.container.data("cal-header",f);$('<a class="ui-btn ui-btn-icon-notext ui-icon-carat-l ui-corner-all app-calendar-prev"><\/a>').attr("title",ti.Previous).appendTo(f);$('<a class="ui-btn ui-btn-icon-notext ui-icon-carat-r ui-corner-all app-calendar-next"><\/a>').attr("title",ti.Next).appendTo(f);k=$('<a class="ui-btn ui-btn-icon-notext ui-icon-calendar ui-corner-all app-calendar-today"><\/a>').attr("title",r.Today);k.appendTo(f);o=$('<div class="app-bar-calendar-footer"> <\/div>').appendTo($app.touch.bar("create",{type:"footer",page:i.container}));v=$('<div class="app-scroll-outer app-bar-system"><\/div>').insertBefore(o.contents().first());it=$('<div class="app-scroll-inner"><\/div>').appendTo(v);v.on("scroll",function(){var n;if(v.data("resizing")){v.removeData("resizing");return}if(n=u.mode,n.match(/day|week/)){var t=v.scrollLeft(),i=u.viewClassName(),r=".app-"+n+"-header",e=g==null;g=function(){u.views[n]._scroll(y.find(i),f.find(r),t,o);g!=null&&requestAnimationFrame(g)};e&&requestAnimationFrame(g)}}).on("scrollstop",function(){clearTimeout(cr);cr=setTimeout(function(){g=null},400)});this.mode.match(/day|week/)&&$app.touch.bar("show",o);i.container.data("cal-footer",o);fu()}this.activeCalendar.end?l.addClass("app-calendar-has-end-time"):l.removeClass("app-calendar-has-end-time");var rt=String.format("app-calendar-{0}view",this.mode),ut=String.format(".app-{0}-header",this.mode),e=l.find("."+rt),ft=c?null:f.find(ut);this.navigateDate&&!this.preventNavigate&&(a=this.getBlockByDate(e,this.navigateDate));e.length>0&&(this.preventNavigate||this.navigateDate&&a&&a.length)?(e.is(":visible")||e.fadeIn("fast"),w.resize(e,ft,o)):e=w.draw(l,this.navigateDate);c||($app.touch.bar("show",f),u.updateHeader(f));this.resetVars()}},scroll:function(n){n.view||(n.view=this.getVisibleView());n.preventNavigate==null&&(n.preventNavigate=this.preventNavigate);n.enhancePrecision==null&&(n.enhancePrecision=this.enhancePrecision);n.animate==null&&(n.animate=this.animate);n.date==null&&(n.date=this.navigateDate);this.getViewHandler().scroll(n);this.resetVars()},hide:function(t){var r=n.dataView(),o=r&&r.extension().viewStyle(),i=this.scrollable();if(i&&(this.lastScrollTop=i.scrollTop()),o!="calendar"){var u=t.container.data("cal-header"),f=t.container.data("cal-footer"),e=n.sidebar(),s=e.find(".app-calendar-color-legend"),i=this.scrollable(),c=i.find('.app-presenter[data-presenter="calendar"]');u&&$app.touch.bar("hide",u);f&&$app.touch.bar("hide",f);h("refresh",{container:e.find(".app-calendar-plugin")});this.activeCalendar.colorMap.hide()}},dispose:function(n){var i=n.container.data("cal-header"),t=this.dataView,r,u;!i||(i.off(),$app.touch.tabs("destroy",{container:i}),$app.touch.bar("remove",i));r=n.container.data("cal-footer");r&&(r.off(),$app.touch.bar("remove",r));n.container.removeData();clearInterval(hr);this.cache.clear(n.container);t.calendar.activeCalendar.colorMap.clearFilter();for(u in this.views)this.views[u].calendar=null;t.calendar=null;t.calendarPlugin.calendar=null;t.calendarPlugin.dataView=null;t.calendarPlugin=null;this.dataView=null;this._scrollable=null},selectEvent:function(t,i,r){function b(t){var r=!1,h=i.is(".app-calendar-selected"),o=n.pageInfo(u._id);a=e=="taphold";s||(o.echoChanged=!0);a||e=="vclick"&&d?(r=!0,t&&(i.removeClass("app-calendar-selected"),u.extension().clearSelection())):e=="contextmenu"&&(n.contextScope(u._id),n.rowContext(i,{x:c,y:l}),n.contextScope(null),r=!0);n.refreshEchoToolbarWithDelay(u,f);r||(n.contextScope(u._id),n.cardPopup({anchor:i,x:c,y:l,dataView:u}),n.contextScope(null))}function k(t){function r(n){var t=n.data("data-context");if(t&&t[h.Name]==w)return n.addClass("app-calendar-selected"),!1}u.extension().tap({row:t},y?"select":"none");v.find(".app-calendar-selected").removeClass("app-calendar-selected");f.find(".app-calendar-selected").removeClass("app-calendar-selected");s?v.find(o.viewClassName()+" .app-event").each(function(){r($(this))}):i.closest(".app-event, .app-calendar-month-more").addClass("app-calendar-selected");f.length&&f.find(".app-event").each(function(){r($(this))});y||(b(!1),n.refreshEchoToolbarWithDelay(u,f))}var e=r.type,d=r.ctrlKey,c=r.pageX,l=r.pageY,v=this.scrollable(),o=this,u=o.dataView,y=u._lookupInfo,s=i.closest(".app-echo").length;if(this.hasKeyFields()){var h=this.dataView._keyFields[0],p=this.getCurrentKey(),w=this.mode!="agenda"&&!s?t[0]:t[h.Name],f=$("#"+u._id+"_echo");if(u._keyFields.length==1){if(hi)return;n.clearHtmlSelection();p!=null&&w==p?b(!0):o.mode=="agenda"?k(t):$app.execute({controller:u._controller,view:u._viewId,filter:[{field:h.Name,operator:"=",value:t[0]}],sort:"",success:function(n){hi||k(n[u._controller][0])},error:function(n){$app.alert(String.format("{0}",n.get_message()))}});i.addClass("ui-btn-active");n.callWithFeedback(i,function(){i.removeClass("ui-btn-active")})}}},showEventList:function(t,r,u,f){var e=this,s=e.getCurrentKey(),o=[];r.forEach(function(n){var t=n[0],i=n[1],r=n[2],c=n[3],h=n[4];o.push({text:e.getEventTitle(i,r,h,""),color:e.activeCalendar.colorMap.color(n[3]),visible:t==s?!0:!1,callback:function(){e.selectEvent(n,u,f)}})});n.listPopup({title:String.format("{0:"+i.LongDatePattern+"}",t),anchor:u,iconPos:"left",items:o})},getViews:function(){return $("#"+this.dataView._id).find('.app-wrapper .app-presenter[data-presenter="calendar"] > div.app-calendar > div')},getVisibleView:function(){return this.scrollable().find('.app-presenter[data-presenter="calendar"] > div.app-calendar > div.app-calendar-'+this.mode+"view")},getViewHandler:function(){return this.views[this.mode]},resetVars:function(){this.preventNavigate=null;this.lastDate=this.navigateDate;this.navigateDate=null;this.enhancePrecision=null;this.animate=null},clear:function(n){var t=this.getVisibleView(),i;this.cache.clear();for(i in this.views)this.views[i].clear(i==this.mode?n:!1);t&&t.length&&(this.loadData(t),this.dataView.calendarPlugin&&this.dataView.calendarPlugin.clearCache())},drawDayColumns:function(n,t,i){for(var u,f,o="",r=new Date(n.getFullYear(),n.getMonth(),n.getDate()),s=0;s<t;s++)u='<div data-cal-year="'+r.getFullYear()+'" data-cal-month="'+r.getMonth()+'" data-cal-day="'+r.getDate()+'" class="app-calendar-day',k(r)&&(u+=" current-day-column"),e[r.getDay()]==6&&(u+=" endofweek"),u+='">',f="",i&&(f+=this.drawTimeColumn(n)),f+='<div data-cal-hour="0"><\/div><div data-cal-hour="0"><\/div><div data-cal-hour="1"><\/div><div data-cal-hour="2"><\/div><div data-cal-hour="3"><\/div><div data-cal-hour="4"><\/div><div data-cal-hour="5"><\/div><div data-cal-hour="6"><\/div><div data-cal-hour="7"><\/div><div data-cal-hour="8"><\/div><div data-cal-hour="9"><\/div><div data-cal-hour="10"><\/div><div data-cal-hour="11"><\/div><div data-cal-hour="12"><\/div><div data-cal-hour="13"><\/div><div data-cal-hour="14"><\/div><div data-cal-hour="15"><\/div><div data-cal-hour="16"><\/div><div data-cal-hour="17"><\/div><div data-cal-hour="18"><\/div><div data-cal-hour="19"><\/div><div data-cal-hour="20"><\/div><div data-cal-hour="21"><\/div><div data-cal-hour="22"><\/div><div data-cal-hour="23"><\/div><div data-cal-hour="0"><\/div><ul class="app-calendar-eventlist"><\/ul><div class="app-clear-fix"><\/div>',u+=f+"<\/div>",o+=u,r.setDate(r.getDate()+1);return o},drawDayHeaders:function(n,t){for(var u="",r=new Date(n.getFullYear(),n.getMonth(),n.getDate()),f=0;f<t;f++){var o=e[r.getDay()],s=i.DayNames[r.getDay()],h=i.AbbreviatedDayNames[r.getDay()];u+='<li  data-cal-year="'+r.getFullYear()+'" data-cal-month="'+r.getMonth()+'" data-cal-day="'+r.getDate()+'" class="';o==0&&(u+=" first-day-of-week");o==6&&(u+=" last-day-of-week");u+='"><a class="ui-btn" title="'+s+'"><span class="letter-day">'+h.substring(0,1)+'<\/span><span class="abbr-day">'+h+'<\/span><span class="full-day">'+s+"<\/span>&nbsp;<div";k(r)&&(u+=' class="app-current-day"');u+=">"+r.getDate()+"<\/div><\/a><\/li>";r.setDate(r.getDate()+1)}return u},drawTimeColumn:function(){for(var u,f,e='<div class="app-calendar-time"><ul>',t,o=!!i.AMDesignator.length,n=0;n<=24;n++)o?n==12?t=r.Noon:(u=n%12,f=n<12?i.AMDesignator:i.PMDesignator,(n==0||n==24)&&(u=12,f=i.AMDesignator),t=String.format("{0} {1}",u,f)):t=n==24?0:n,e+='<li><span data-cal-hour="'+n+'">'+t+"<\/span><\/li>";return e+'<\/ul><div class="app-current-time"><\/div><\/div>'},getBlocks:function(){return this.getViewHandler().getBlocks()},getMostVisibleBlock:function(n){var t,r,i,u;n||(n=this.scrollable());r=n.height()/2;i=$(this.getBlocks(n));switch(this.mode){case"day":case"week":if(i.each(function(){var n=$(this);if(t||(t=n),n.position().left>n.width()/2)return!1;t=n}),this.mode=="week")while(t&&t.length&&t.position().left+t.width()<=ot)u=t.next(),t=u;break;case"year":case"month":case"agenda":i.each(function(){var n=$(this);return t=n,n.offset().top+n.height()>r?!1:void 0})}return t},getFirstVisibleBlock:function(t){var u,f;t||(t=this.scrollable());var e=n.stickyHeaderBar().outerHeight()+t.offset().top,r=$(this.getBlocks(t)),i=r.eq(0),o=i.width(),s=this.getVisibleView(),h=parseInt(s.css("marginLeft"),10);switch(this.mode){case"day":case"week":u=Math.floor(-h/o);i=r.eq(u);i&&i.length&&i.position().left<0&&(f=r.eq(u+1),f.length&&(i=f));break;case"month":case"year":case"agenda":r.each(function(){var n=$(this);if(n.offset().top>e)return!1;i=n})}return i},getLastVisibleBlock:function(n){var t,r=n.height()+n.position().top,u=n.width(),i=$(this.getBlocks(n));switch(this.mode){case"day":case"week":i.each(function(){var n=$(this);if(t||(t=n),n.position().left>=u)return!1;t=n});break;case"month":case"year":case"agenda":i.each(function(){var n=$(this);if(t||(t=n),n.offset().top>r)return!1;t=n})}return t},getBlockByDate:function(n,t){var i=t.getFullYear(),r=t.getMonth(),u=t.getDate();if(!n||!n.length)return null;switch(this.mode){case"year":return n.find(String.format('.app-calendar-year[data-cal-year="{0}"]',i));case"month":return n.find(String.format('.app-calendar-month[data-cal-year="{0}"][data-cal-month="{1}"]',i,r));case"week":case"day":return n.find(String.format('.app-calendar-day[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day="{2}"]',i,r,u));case"agenda":return n.find(String.format('li[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day="{2}"] ul',i,r,u))}},resizeScroller:function(n,t,i){var r=t.find(".app-scroll-outer"),u=parseInt(n.css("marginLeft"),10)*-1;i&&r.find(".app-scroll-inner").css("width",i);r.scrollLeft(u).data("resizing",!0)},updateHeader:function(n){var r=this;fi||(fi=setTimeout(function(){var v=r.scrollable(),at=r.mode,et=n.find(".app-tabs"),ot=et.css("visibility")!="hidden",y=r.getFirstVisibleBlock(v),l,ut,ft;if(y){var c=n.find(".app-calendar-badge"),e=t(y),u=e.getFullYear(),w=e.getMonth(),vt=e.getDay(),o=e.getDate(),s=i.MonthNames[w],h=i.AbbreviatedMonthNames[w],yt=ot?et.find("ul").offset().left-c.offset().left:n.find("a.app-calendar-today").offset().left,ht=1,f=[];switch(at){case"year":f=["<b>"+u+"<\/b>&nbsp;"];l=y.find("h1");l.is("app-in-header")||(v.find(".app-calendar-yearview .app-calendar-year h1.app-in-header").removeClass("app-in-header"),l.addClass("app-in-header"));break;case"month":f=[String.format("<b>{0}<\/b> {1}",s,u),String.format("<b>{0}<\/b> {1}",h,u),String.format("<b>{0}<\/b>",s),String.format("<b>{0}<\/b>",h)];l=y.find("h1.app-calendar-month-header");l.is("app-in-header")||(v.find(".app-calendar-monthview .app-calendar-month h1.app-calendar-month-header.app-in-header").removeClass("app-in-header"),l.addClass("app-in-header"));break;case"week":var b=r.getLastVisibleBlock(v),k=b?t(b):new Date,d=k.getFullYear(),g=k.getMonth(),a=k.getDate(),p=w==g,nt=u==d,tt=i.MonthNames[g],it=i.AbbreviatedMonthNames[g];if(!b)return;f.push(String.format("<b>{0} {1}<\/b>{2} - <b>{3}{4}<\/b>, {5}",s,o,nt?"":", "+u,p?"":tt+" ",a,d),String.format("<b>{0} {1}<\/b>{2} - <b>{3}{4}<\/b>, {5}",h,o,nt?"":", "+u,p?"":it+" ",a,d));nt?f.push(String.format("<b>{0} {1}<\/b> - {2}{3}",s,o,p?"":tt+" ",a),String.format("<b>{0} {1}<\/b> - {2}{3}",h,o,p?"":it+" ",a),String.format("<b>{0} {1}<\/b>, {2}",s,o,u),String.format("<b>{0} {1}<\/b>, {2}",h,o,u)):f.push(String.format("<b>{0} {1}<\/b>, {2} - <b>{3} {4}<\/b>",s,o,u,tt,a),String.format("<b>{0} {1}<\/b>, {2} - <b>{3} {4}<\/b>",h,o,u,it,a),String.format("<b>{0} {1}<\/b>, {2}",s,o,u),String.format("<b>{0} {1}<\/b>, {2}",h,o,u));break;case"agenda":case"day":var pt=i.DayNames[st[vt]],wt=new RegExp(pt+"(.?) ","i"),rt=String.format("{0:"+i.MonthDayPattern+"}",e),bt=new RegExp(rt,"i"),ct=String.format("{0:"+i.LongDatePattern+"}",e).replace(bt,"<b>"+rt+"<\/b>"),lt=ct.replace(wt,"");f=[ct,lt,lt.replace(i.MonthGenitiveNames[e.getMonth()],i.AbbreviatedMonthGenitiveNames[e.getMonth()])];e.getFullYear()==(new Date).getFullYear()&&f.push("<b>"+rt+"<\/b>",String.format("<b> {0:"+i.MonthDayPattern.replace(/M+/,"MMM")+"}<\/b>",e));f.push(e.toLocaleDateString())}for(f[0]&&(ut=f[0].replace(/<\/?b>|&nbsp;/g,""),c.html(f[0]).attr("title",ut).attr("data-cal-value",ut));c[0].clientWidth+5>yt;){if(ft=f[ht],!ft)break;c.html(ft);ht++}ot?c.removeClass("app-has-droparrow"):c.addClass("app-has-droparrow");fi=null}},300))},scrollView:function(t){var f=this.scrollable(),o=this.dataView,r=this.getVisibleView(),i,e=t=="next"?1:-1,u;i=t!="today"?this.getViewHandler().getNextDate(r,e):new Date;u=this.getBlockByDate(r,i);u.length?this.scroll({date:i,animate:!0,view:r}):(this.navigateDate=i,n.presenter("show",{id:this.dataView._id,name:"calendar",container:f}))},loadData:function(n){var t=this,f=t.dataView.extension().viewStyle();if(this.mode=="agenda"&&t.activeCalendar.colorMap.load(!0),n.is(":visible")&&this.mode!="agenda"&&f=="calendar"){var i=n.closest(".app-wrapper"),r=t.getFirstVisibleBlock(i),u=t.getLastVisibleBlock(i);r&&u&&t.loadDataInBlock(n,r,u)}},loadDataInBlock:function(n,i,r){function h(){o?u.loadDataInBlock(n,o,r):u.activeCalendar.colorMap.load(!0)}var u=this,o=i.next(":not(.current-time-line)"),s=u.mode,f,e;if(i[0]!=r[0]&&o.length||(o=null),!this.loadingData&&u.mode!="agenda")if(i.hasClass("data-loaded"))h();else{if(!u.blockIsVisible(n,i)){h();return}f=t(i);e=this.cache.select(f);e?($.isEmptyObject(e)||this.getViewHandler().addData(n,f,e),this.loadingData=!1,i.addClass("data-loaded"),h()):this.requestData({mode:s,date:f,success:function(t){u.cache.insert(f,t.Pivots.pivot0.Data.slice(1));callback=function(){if(u.blockIsVisible(n,i)){switch(s){case"day":i.find("td > ul").empty();break;case"week":i.find("td > ul").empty();break;case"month":i.find("td > ul").empty();break;case"year":i.find("td.app-has-data").removeClass("app-has-data");break;case"agenda":return}i.addClass("data-loaded");e=u.cache.select(f);$.isEmptyObject(e)||u.views[s].addData(n,f,e);h()}pt=null};yt&&!s.match(/day|week/)?pt=callback:callback()}})}},requestData:function(n){var i=this,t=i.activeCalendar,u={controller:i.dataView._controller,command:n.mode=="agenda"?"Select":"Pivot",view:i.dataView._viewId,sort:t.date.Name,tags:i.dataView.get_tags(),fieldFilter:[t.date.Name],success:function(t){i.loadingData=!1;n.success(t)},error:function(n){i.loadingData=!1;$app.alert(String.format("{0}",n.get_message()))}};if(t.text&&(u.fieldFilter.push(t.text.Name),t.text.AliasIndex!=0&&u.fieldFilter.push(i.dataView._allFields[t.text.AliasIndex].Name)),t.color&&(u.fieldFilter.push(t.color.Name),t.color.AliasIndex!=0&&u.fieldFilter.push(i.dataView._allFields[t.color.AliasIndex].Name)),t.end&&u.fieldFilter.push(t.end.Name),n.mode){var o=n.date,r=new Date(o),t=i.activeCalendar,e={},f=e[t.date.Name]=["calendar-date","pivot-val2-count","pivot-row1-year","pivot-row2-month-raw","pivot-row3-day"],s=e[t.text.Name],h=t.color?e[t.color.Name]:null,c=t.end?e[t.end.Name]=["calendar-end"]:null;s||(s=e[t.text.Name]=["calendar-text"]);t.color&&!h&&(h=e[t.color.Name]=["calendar-color"]);switch(n.mode){case"daylist":r.setDate(r.getDate()+1);f.push("pivot-val1-calendar-first100");break;case"day":r.setDate(r.getDate()+1);f.push("pivot-row4-halfhour");f.push("pivot-val1-calendar");break;case"week":r.setDate(r.getDate()+7);f.push("pivot-row3-day","pivot-row4-halfhour");f.push("pivot-val1-calendar");break;case"month":r.setMonth(r.getMonth()+1);f.push("pivot-row3-day");f.push("pivot-val1-calendar-first5");break;case"year":r.setYear(r.getFullYear()+1);f.push("pivot-row3-day")}r.setSeconds(-1);u.pivotDefinitions=e;u._filter=ht(i.dataView,t.date,null,o,r)}else n.pivots&&n.date&&n.end&&(u.pivotDefinitions=n.pivots,u._filter=ht(i.dataView,t.date,null,n.date,n.end));i.loadingData=!0;$app.execute(u)},blockIsVisible:function(n,t){var i;if(!n.is(":visible"))return!1;if(i=n.closest(".app-wrapper"),this.mode.match(/month|year/)){var r=i.offset().top,f=r+i.height(),u=t.offset().top,e=u+t.height(),s=u<=f&&u>=r,h=e>=r&&e<=f,c=u<=r&&e>=f;return s||h||c}if(this.mode.match(/day|week/)){var l=i.width(),o=t.position().left,a=o+t.width();return a>=0&&o<=l}return!0},hasKeyFields:function(){return this.dataView._keyFields.length>0},getCurrentKey:function(){if(!this.hasKeyFields())return null;var t=this.dataView._keyFields[0],n=this.dataView.extension().commandRow();return n?n[t.Index]:null},getEventTitle:function(n,t,i,r){var u=f(n,!0);return t&&(u+="-"+f(t,!0)),u+="\n"+(i?i:o.Data.NullValueInForms),this.activeCalendar.color&&r!=""&&(u+="\n"+(r?r:o.Data.NullValueInForms)),u},getActionsByName:function(t){var i=[],r=[];return n.navContext(i),i.forEach(function(n){n.command==t&&r.push(n)}),r},drawDayData:function(n,t,i,r){var u=this;i.rows.forEach(function(t){var i=u.drawEvent(t,r);i.appendTo(n)});this.resizeDayData(n.find("li"))},drawEvent:function(t,i){var e=this,y=t[0],s=t[1],u=t[2],c=t[3],h=t[4],l=f(s,!1,!0),a=f(s);u&&(l+="-"+f(u,!1,!0),a+=" - "+f(u));var v=String.format('<div class="app-event-data"><span class="app-event-time">{0}<\/span> {1} <div class="app-event-time-long">{2}<\/div><\/div>',l,h?h:o.Data.NullValueInForms,a),r=$('<li class="app-event"><\/li>').data("data-context",t),p=e.getEventTitle(s,u,h,c),w=e.activeCalendar.colorMap.className(c);return n.desktop()&&!this.dataView.get_isTagged("calendar-drag-disabled")&&(r.attr("data-draggable","calendar-event"),e.activeCalendar.end&&(v+='<div class="app-event-handle ui-icon-dots" data-draggable="calendar-event-handle"><\/div>')),i&&i==y&&r.addClass("app-calendar-selected"),u&&r.addClass("app-event-has-end-time"),r.addClass(w),r.html(v),r.attr("title",p),r},resizeDayData:function(n){var e=[],t=[],h=l/25,s=n.first().closest(".app-calendar-day").width()-(this.mode=="day"?150:10),c=this.mode=="day"?10:4,i,u,f,r;n.each(function(){var i=$(this);if(i.is(".app-event-more")){i.remove();return}var r=i.data("data-context"),t=r[1],n=r[2];!n||n.getTime()<t.getTime()?(n=new Date(t),n.setMinutes(n.getMinutes()+tu)):n.getDate()!=t.getDate()&&(n=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59));e.push({element:i,data:r,start:t.getTime(),end:n.getTime(),depth:1,width:0})});e.sort(function(n,t){return n.start!=t.start?n.start>t.start?1:-1:n.end!=t.end?n.end<t.end?1:-1:0});u=[];r=0;e.forEach(function(n){function e(){n.depth=t.length+1;n.depth>r&&(r=n.depth);t.push(n);u.push(n)}for(i=t.pop();i;)if(i.end<=n.start)i=t.pop(),i||(u.forEach(function(n){n.width=r}),r=0,u=[]);else{t.push(i);break}t.length>=c?f?(n.collapsed=!0,f.collapsedEvents.push(n.data)):(f=n,f.collapsedEvents=[n.data],e()):(f=null,e())});u.forEach(function(n){n.width=r});e.forEach(function(n){var i,r;if(n.collapsed)n.element.hide();else{var t=n.element,u=n.data[1],e=n.data[2],c=h*(u.getHours()+u.getMinutes()/60)+22,l=yr(n.start,n.end),f=s/n.width,a=s*(n.depth-1)/n.width;n.depth!=n.width&&(f*=1.3);n.collapsedEvents&&n.collapsedEvents.length>1&&(t.hide(),i="+"+n.collapsedEvents.length+" "+o.Mobile.More,t=$('<li class="app-event app-event-more ui-icon-dots"><\/li>').appendTo(t.closest("ul")).html(i).attr("title",i).data("data-more-context",n.collapsedEvents));r={top:c,"z-index":n.depth+2,marginLeft:a+"px",width:f-3+"px"};e&&(r.height=l);t.css(r)}})}};wi=function(n){this.calendar=n};wi.prototype={draw:function(n,t){var u,a;n.find(".app-calendar-dayview").remove();var i=$('<div class="app-calendar-dayview"><\/div>').appendTo(n),o=i.closest(".app-echo").length>0,s=i.closest(".app-presenter"),v=i.closest(".app-wrapper"),h=s.data("cal-header"),l=o?null:s.data("cal-footer"),c=o?1:y.day*7,p=(y.day-1)/2*7,r=new Date(t.getFullYear(),t.getMonth(),t.getDate()),f='<div class="app-calendar-day-grid"><div class="current-time-line"><div class="dot"><\/div><\/div>';return r.setDate(r.getDate()-e[r.getDay()]),h.find(".app-day-header").remove(),u=$('<div class="app-day-header" data-draggable="calendar-bar-day"><\/div>').appendTo(h),a=$("<ul> "+this.calendar.drawDayHeaders(r,c)+" <\/ul>").appendTo(u),b(u),f+=this.calendar.drawDayColumns(r,c,!0),f+="<\/div>",i.html(f).find(".app-calendar-day").hide(),this.resize(i,u,l),this.scroll({view:i,date:t,enhancePrecision:!0}),i},showHeaderAndFooter:function(n,t){n.find(".app-day-header").show();n.find(".app-week-header").hide();n.find(".app-month-header").hide();$app.touch.bar("show",t);this.calendar.lastDayScrollTop=this.calendar.scrollable().scrollTop()},resize:function(n,t,i){t.is(".app-day-header")||(t=t.find(".app-day-header"));var u=n.closest(".app-echo").length>0,k=n.find(".app-calendar-day-grid"),f=n.find(".app-calendar-day"),r=t.find("li"),d=this.calendar.scrollable(),e=d.outerWidth(),g=Math.floor(e/7),c=f.length*e,a=this.calendar.navigateDate&&!this.calendar.preventNavigate,o,h,v,y,p,w;if(a||(o=it(f),h=u?null:it(r),v=o.position().left,y=u?0:h.position().left,p=parseInt(n.css("marginLeft"),10)*-1,w=u?0:parseInt(t.css("marginLeft"),10)*-1),k.width(c),t.width(r.width()*r.length),r.closest("ul").css("visibility",""),r.width(g),f.width(e).fadeIn("fast"),n.height(l),!u){if(a)this.scroll({view:n,date:this.calendar.navigateDate});else{var nt=o.position().left,tt=h.position().left,rt=v-nt,b=Math.floor(y-tt);b!=0&&t.css("marginLeft",w*-1+b);this._scroll(n,t,p-rt,i)}i!=null&&this.calendar.resizeScroller(n,i,c)}s();this.resizeData(n)},scroll:function(t){var e=this,r=e.calendar,o=r.dataView.extension().commandRow(),y=r.scrollable(),u=t.view,p=t.animate,h=u.closest(".app-presenter"),w=h.data("cal-header").find(".app-day-header"),b=h.data("cal-footer"),i=t.date,c=r.getBlockByDate(u,i),l,a,f,v;c.length&&(l=parseInt(u.css("marginLeft"),10),a=c.position().left,e._scroll(u,w,a-l,b,p));t.enhancePrecision&&(o?(v=o[r.activeCalendar.date.Index],f=s(v,"find")):f=i.getHours()==0&&i.getMinutes()==0&&i.getSeconds()==0&&i.getMilliseconds()==0?r.lastDayScrollTop||s():s(i,"find"),n.scroll(y,f))},_scroll:function(i,r,u,f,e){var h;n.animate()||(e=!1);var l=parseInt(i.css("marginLeft"),10),s=u*-1,o=this,c=i.find(".app-calendar-day-grid");if(i.removeClass("app-has-current-day"),oi++,e==!0){i.animate({marginLeft:s},bt,function(){o._scroll(i,r,u,f)});return}i.css("marginLeft",s);h=this.updateDayHeader(i,r);clearTimeout(wt);wt=setTimeout(function(){var n=i.find(".app-calendar-day"),e=it(n),k=n.width(),a=u%k,v,w=y.day*7,b=si.day*7,nt,ft,et,ht,ct,p,tt,d,g;if(oi==1&&a!=0?(s>l?(a=a*-1,e=e.prev(),e.is(".current-time-line")&&(e=e.prev())):(a=k-a,e=e.next(),e.is(".current-time-line")&&(e=e.next())),h=o.updateDayHeader(i,r,e)):a=a>k/2?k-a:a*-1,nt=s-a,ft=nt*-1,u<k)p=n.first(),tt=p.position().left,v=t(p),v.setDate(v.getDate()-w),$(o.calendar.drawDayColumns(v,w,!0)).prependTo(c),ht=$(o.calendar.drawDayHeaders(v,w)).prependTo(r.find("ul")),n=i.find(".app-calendar-day"),ct=r.find("li"),n.length>b&&(n.slice(b,n.length).remove(),r.find("li").slice(b,n.length).remove()),i.css("marginLeft",(p.position().left-tt)*-1),r.css("marginLeft",h.position().left*-1),f&&o.resize(i,r,f);else if(u>n.width()*(n.length-2)){p=n.last();tt=p.position().left;v=t(p);v.setDate(v.getDate()+1);$(o.calendar.drawDayColumns(v,w,!0)).appendTo(c);$(o.calendar.drawDayHeaders(v,w)).appendTo(r.find("ul"));var ct=r.find("li"),rt=n.length+w,ot=0,et=0;rt>b&&(d=n.slice(0,rt-b),g=r.find("li").slice(0,rt-b),ot=d.width()*d.length,et=g.width()*g.length,d.remove(),g.remove());i.css("marginLeft",parseInt(i.css("marginLeft"),10)+ot-a);r.css("marginLeft",parseInt(r.css("marginLeft"),10)+et);f&&o.resize(i,r,f)}else{function st(){f&&f.length&&f.scrollLeft()!=ft&&o.calendar.resizeScroller(i,f);o.calendar.updateHeader(r.closest(".app-bar-calendar"))}a!=0?i.animate({marginLeft:nt},{duration:bt,done:st}):st()}e.is(".current-day-column")&&i.addClass("app-has-current-day");ut();oi=0},250)},updateDayHeader:function(n,i,r){var a=n.find(".app-calendar-day"),v=r&&r.length?r:it(a),u=t(v),s=it(i.find("ul li")),f=t(s),o=s,h,c,l;return i.find("li .visible-day").removeClass("visible-day"),h=i.find(String.format('li[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day="{2}"] > a > div',u.getFullYear(),u.getMonth(),u.getDate())),h.addClass("visible-day"),u.setDate(u.getDate()-e[u.getDay()]),f.setDate(f.getDate()-e[f.getDay()]),f.getTime()!=u.getTime()&&(o=i.find(String.format('li[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day="{2}"]',u.getFullYear(),u.getMonth(),u.getDate())),o.length&&(c=parseInt(i.css("marginLeft"),10),l=c-o.position().left,i.css("marginLeft",l))),this.calendar.updateHeader(i.closest(".app-bar-calendar")),o},addData:function(n,t,i){var f=this.calendar.getBlockByDate(n,t,"day"),r=f.find("ul.app-calendar-eventlist"),e=this.calendar.dataView._keyFields[0],u=this.calendar.dataView.extension().commandRow(),o=u?u[e.Index]:null;r.empty();typeof i!="boolean"&&this.calendar.drawDayData(r,t,i,o)},resizeData:function(n){var t=this.calendar,i=n.find(".app-calendar-day");i.each(function(){var i=$(this),n=i.find("li.app-event:not(.app-event-preview)");n.length&&t.resizeDayData(n)})},clear:function(n){var r=this.calendar.scrollable(),i=r.find(".app-calendar-dayview"),t;i.length&&(t=i.find("div.app-calendar-day.data-loaded"),t.removeClass("data-loaded").removeData("calendar-colors"),n&&t.find(".app-event").remove())},getNextDate:function(n,i){var u=this.calendar.getMostVisibleBlock(),r=t(u);return r.setDate(r.getDate()+i),r},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-dayview > .app-calendar-day-grid > .app-calendar-day")}};bi=function(n){this.calendar=n};bi.prototype={draw:function(n,t){var f,w,u,a;t.setDate(t.getDate()-e[t.getDay()]);n.find(".app-calendar-weekview").remove();var i=$('<div class="app-calendar-weekview"><\/div>').appendTo(n),o=this.calendar,v=i.closest(".app-echo").length>0,h=v?7:y.week,c=i.closest(".app-presenter"),k=i.closest(".app-wrapper"),l=c.data("cal-header"),p=c.data("cal-footer"),r=new Date(t.getTime());return r.setDate(r.getDate()-h),l.find(".app-week-header").remove(),f=$('<div class="app-week-header" data-draggable="calendar-bar-week"><\/div>').appendTo(l),w=$("<ul>"+o.drawDayHeaders(r,h*3)+"<\/ul>").appendTo(f),b(f),u='<div class="app-calendar-week-grid"><div class="current-time-line"><div class="dot"><\/div><\/div>',u+=o.drawTimeColumn(r),u+=o.drawDayColumns(r,h*3,!1),u+="<\/div>",i.html(u),a=i.find(".app-calendar-week-grid").hide(),this.resize(i,f,p),this.scroll({view:i,date:t,enhancePrecision:!0}),this.validateCurrentDay(i,a),s(),i},showHeaderAndFooter:function(n,t){n.find(".app-day-header").hide();n.find(".app-week-header").show();n.find(".app-month-header").hide();$app.touch.bar("show",t);this.calendar.lastDayScrollTop=this.calendar.scrollable().scrollTop()},_timelineDot:function(n,t){var o=this.calendar.scrollable(),u=n.find(".app-calendar-week-grid"),f,i=u.find(".current-time-line .dot"),e,r;t?(r=i.show().width(),f=u.find(".current-day-column"),f.length&&(e=f.offset().left-o.offset().left-r/2+parseInt(u.css("margin-left")),e+r<o.width()-r*3?setTimeout(function(){i.css("marginLeft",e).show()}):i.hide())):i.hide()},resize:function(n,t,i){t.is(".app-week-header")||(t=t.find(".app-week-header"));var u=n.closest(".app-echo").length>0,a=n.find(".app-calendar-week-grid"),v=n.find(".app-calendar-week-grid > div:not(.current-time-line):not(.app-calendar-time) > div"),r=t.find("li"),y=this.calendar.scrollable(),p=y[0].scrollWidth-ot,f=Math.floor(p/7),e=f*(r.length+1)+ot,o=it(r),w=u?0:o.position().left,h=u?0:parseInt(t.css("marginLeft"),10)*-1;if(r.width(f),r.closest("ul").css("visibility",""),v.width(f),a.width(e).fadeIn("fast"),n.height(l),!u){var b=o.position().left,c=w-b,k=h-c;this._timelineDot(n,!0);this._scroll(n,t,h-c,i);i!=null&&this.calendar.resizeScroller(n,i,e);this.resizeData(n)}s()},scroll:function(t){var a,v,f,y;t.date.setDate(t.date.getDate()-e[t.date.getDay()]);var o=this,r=o.calendar,u=t.view,p=t.animate,i=t.date,h=r.dataView.extension().commandRow(),c=u.closest(".app-presenter"),w=r.scrollable(),b=c.data("cal-header").find(".app-week-header"),k=c.data("cal-footer"),l=r.getBlockByDate(u,i);l.length&&(a=parseInt(u.css("marginLeft"),10),v=l.position().left-ot,o._scroll(u,b,v-a,k,p));t.enhancePrecision&&(h?(y=h[r.activeCalendar.date.Index],f=s(y,"find")):f=i.getHours()==0&&i.getMinutes()==0&&i.getSeconds()==0&&i.getMilliseconds()==0?r.lastDayScrollTop||s():s(i,"find"),n.scroll(w,f))},_scroll:function(i,r,u,f,e){function ft(){h.updateHeader(it);b||(u<ht?ct():w.position().left<st?lt():o.validateCurrentDay(i,c));f&&f.length&&f.scrollLeft()!=u&&h.resizeScroller(i,f);ut(tt);o._timelineDot(i,!0)}function v(n,t,i){var r=i.getDate();n.attr("data-cal-year",i.getFullYear()).attr("data-cal-month",i.getMonth()).attr("data-cal-day",r).data("calendar-colors",t.data("calendar-colors")).find("ul").empty().append(t.find("ul li"));n[0].className=t[0].className}function et(n,t){var i=t.getDate();n.attr("data-cal-year",t.getFullYear()).attr("data-cal-month",t.getMonth()).attr("data-cal-day",i);n.data("calendar-colors",null);n.find("ul").empty().removeClass("data-loaded");n[0].className="app-calendar-day";k(t)&&n.addClass("current-day-column")}function ct(){b=!0;var p=s.first(),nt=c.find(".current-time-line"),f=t(p),y=!1;f.setDate(f.getDate()-d);var w=r.find("li"),e=s.slice(0,7),l=s.slice(7,14),g=s.slice(14,21),n=new Date(f);return w.each(function(){var r=$(this),t=r.find("a div"),i=n.getDate();t.text(i);r.attr("data-cal-year",n.getFullYear()).attr("data-cal-month",n.getMonth()).attr("data-cal-day",i);k(n)?t.addClass("app-current-day"):t.removeClass("app-current-day");n.setDate(i+1)}),n=t(l.first()),g.each(function(t){v($(this),l.eq(t),n);n.setDate(n.getDate()+1)}),n=t(e.first()),l.each(function(t){v($(this),e.eq(t),n);n.setDate(n.getDate()+1)}),n=f,e.each(function(){et($(this),n);var t=h.cache.select(n);t&&(o.addData(i,n,t),y=!0);n.setDate(n.getDate()+1)}),o.validateCurrentDay(i,c),y&&o.resizeData(i),u-=a,u>0&&(u=0),i.css("marginLeft",u),r.css("marginLeft",u),a}function lt(){b=!0;var p=s.first(),nt=c.find(".current-time-line"),e=t(p),y=!1;e.setDate(e.getDate()+d);var w=r.find("li"),g=s.slice(0,7),l=s.slice(7,14),f=s.slice(14,21),n=new Date(e);return w.each(function(){var r=$(this),t=r.find("a div"),i=n.getDate();t.text(i);r.attr("data-cal-year",n.getFullYear()).attr("data-cal-month",n.getMonth()).attr("data-cal-day",i);k(n)?t.addClass("app-current-day"):t.removeClass("app-current-day");n.setDate(i+1)}),n=t(l.first()),g.each(function(t){v($(this),l.eq(t),n);n.setDate(n.getDate()+1)}),n=t(f.first()),l.each(function(t){v($(this),f.eq(t),n);n.setDate(n.getDate()+1)}),n=t(f.last()),n.setDate(n.getDate()+1),f.each(function(){et($(this),n);var t=h.cache.select(n);t&&(o.addData(i,n,t),y=!0);n.setDate(n.getDate()+1)}),o.validateCurrentDay(i,c),u-=a,y&&o.resizeData(i),u>0&&(u*=-1),i.css("marginLeft",u),r.css("marginLeft",u),a}var p,g,nt;n.animate()||(e=!1);var o=this,h=o.calendar,tt=h.scrollable(),st=tt.width(),c=i.find(".app-calendar-week-grid"),s=c.find(".app-calendar-day"),it=r.closest(".app-bar-calendar"),w=s.last(),l=w.width(),at=w.position().left-ot+l,b=!1,rt=r.find("li:first-of-type"),vt=t(rt),ht=rt.width()+2,yt=si.week,d=y.week,a=l*d;o._timelineDot(i,!1);h.updateHeader(it);e==!0?(p=u%l,g=u*-1+(p>l/2?p-l:p),r.animate({marginLeft:g},bt),i.animate({marginLeft:g},bt,function(){setTimeout(function(){ft()})})):(nt=u*-1,r.css("marginLeft",nt),i.css("marginLeft",nt),clearTimeout(wt),wt=setTimeout(ft,250))},addData:function(n,t,i){var f=this.calendar.dataView._keyFields[0],u=this.calendar.dataView.extension().commandRow(),e=u?u[f.Index]:null,o=this.calendar.getBlockByDate(n,t,"day"),r=o.find("ul.app-calendar-eventlist");r.empty();r.data("calendar-event-count",i.count||0);this.calendar.drawDayData(r,t,i,e)},resizeData:function(n){var t=this.calendar,i=n.find(".app-calendar-day");i.each(function(){var i=$(this),n=i.find("li.app-event:not(.app-event-preview)");n.length&&t.resizeDayData(n)})},clear:function(n){var r=this.calendar.scrollable(),i=r.find(".app-calendar-weekview"),t;i.length&&(t=i.find("div.app-calendar-day.data-loaded"),t.removeClass("data-loaded").removeData("calendar-colors"),n&&t.find(".app-event").remove())},validateCurrentDay:function(n,t){n.is(".app-has-current-day")?t.find(".current-day-column").length||n.removeClass("app-has-current-day"):t.find(".current-day-column").length&&n.addClass("app-has-current-day")},getNextDate:function(n,i){var f=this.calendar.getMostVisibleBlock(),r=t(f),u=e[r.getDay()];return u==0?r.setDate(r.getDate()+i*7):r.setDate(r.getDate()+(i==-1?u*-1:7-u)),r},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-weekview > .app-calendar-week-grid > .app-calendar-day")}};ki=function(n){this.calendar=n};ki.prototype={draw:function(n,t){var e,w,v,rt,u,it,p,ut;n.find(".app-calendar-monthview").remove();var r=$('<div class="app-calendar-monthview"><\/div>').hide().appendTo(n),ft=this.calendar,s=r.closest(".app-echo").length>0,nt=r.closest(".app-presenter"),h=nt.data("cal-header"),l=s?0:y.month,tt=t.getMonth(),f=new Date(t.getFullYear(),tt),a,it;for(f.setMonth(f.getMonth()-l),a=f.getMonth(),h.find(".app-month-header").remove(),e=$('<div class="app-month-header"><\/div>'),w=$("<ul><\/ul>").appendTo(e),u=0;u<7;u++){var o=st[u],k=i.DayNames[o],d=i.AbbreviatedDayNames[o],g=$('<li><span class="letter-day">'+d.substring(0,1)+'<\/span><span class="abbr-day">'+d+'<\/span><span class="full-day">'+k+"<\/span><\/li").attr("title",k);(o==0||o==6)&&g.addClass("app-calendar-weekend");g.appendTo(w)}for(b(e),e.appendTo(h),$app.touch.bar("show",h),r.fadeIn("fast"),v=$('<div class="app-calendar-load-at-top"><\/div>').appendTo(r),rt=$('<a href="#" class="dv-load-at-top ui-btn"/>').appendTo(v).text(c.Loading),s&&v.hide(),u=l*-1;u<=l;u++)it=this.drawMonth(f).appendTo(r),f.setMonth(a+1),a=f.getMonth();return this.resize(r),p=$('<div class="app-calendar-load-at-bottom"><\/div>').appendTo(r),ut=$('<a href="#" class="dv-load-at-bottom ui-btn">Load more<\/a>').appendTo(p).text(c.Loading),s&&p.hide(),this.scroll({date:t,view:r}),r},showHeaderAndFooter:function(n,t){n.find(".app-day-header").hide();n.find(".app-week-header").hide();n.find(".app-month-header").show();$app.touch.bar("hide",t)},resize:function(n,t,i,r){var o=n.closest(".app-wrapper"),u=n.find(".app-calendar-month"),f=u.find("table"),e=o.height()-u.first().find(".app-calendar-month-header").outerHeight();r&&u.removeClass("data-loaded");f.height(e);f.each(function(){var t=$(this),n=t.find("tr");n.height(e/n.length)});this.calendar.navigateDate&&!this.calendar.preventNavigate&&this.scroll({view:n,date:this.calendar.navigateDate})},scroll:function(t){function o(){n.fetchOnDemand();ut(i)}var s=this,h=t.date,u=s.calendar,i=u.scrollable(),c=t.view.closest("div.app-presenter"),a=c.data("cal-header"),r=u.getBlockByDate(t.view,t.date),f=r.find(".app-calendar-month-header");if(r){r=r.find('td[data-cal-day="'+h.getDate()+'"]');var l=i.find(".app-presenter-instruction"),e=Math.abs(r.position().top),e=f.offset().top-i.offset().top+f.outerHeight(!0)-l.outerHeight(!0)+i.scrollTop();t.animate?n.animatedScroll(i,e,o):(n.scroll(i,e),o())}},clear:function(n){var r=this.calendar.scrollable(),i=r.find(".app-calendar-monthview"),t;i.length&&(t=i.find("div.app-calendar-month.data-loaded"),t.removeClass("data-loaded").removeData("calendar-colors"),n&&t.find(".app-event").remove())},drawMonth:function(n){var s=n.getMonth(),c=i.MonthNames[s],h=$('<div class="app-calendar-month"><\/div>').attr("data-cal-year",n.getFullYear()).attr("data-cal-month",s),l=$('<h1 class="app-calendar-month-header">').appendTo(h),y=$("<table><\/table>").appendTo(h),o,r;s==0?l.text(String.format("{0} {1}",c,n.getFullYear())):l.text(c);var t=new Date(n.getFullYear(),n.getMonth(),1),u=e[t.getDay()],f=new Date(n.getFullYear(),n.getMonth()+1,1),a=e[f.getDay()],v;for(a!=0&&f.setDate(f.getDate()+(6-a)+1),u!=0&&t.setDate(t.getDate()-u);t<f;){if(o=t.getDay(),u=e[o],u==0&&(v=$("<tr><\/tr>").appendTo(y)),r=$("<td><\/td>").appendTo(v),(o==0||o==6)&&r.addClass("app-calendar-weekend"),t.getMonth()==n.getMonth()){r.html("&nbsp;");r.attr("data-cal-day",t.getDate());var p=$('<a class="ui-btn"><\/a>').appendTo(r),w=$("<span><\/span>").text(t.getDate()).appendTo(p),b=$("<ul><\/ul>").appendTo(r),k=$('<li class="app-calendar-month-more"><\/li>').appendTo(b);et.setHours(0,0,0,0)==t.setHours(0,0,0,0)&&w.addClass("app-current-day")}else r.html("&nbsp;");t.setDate(t.getDate()+1)}return h},addData:function(n,t,i){var s=this.calendar,l=s.getBlockByDate(n,t,"month"),tt=s.dataView,ot=tt._keyFields[0],st=s.activeCalendar,r=s.dataView.extension().commandRow(),w=r?r[ot.Index]:null,a=r?r[st.date.Index]:null,it,v,ht=l.find("td").first(),ct=l.find("td > a").first(),rt=l.find("ul"),b,et;rt.hide();it=ht.outerHeight()-ct.height();rt.show();for(b in i){var k=i[b],d=k.count,h=null,y=l.find('td[data-cal-day="'+b+'"] ul'),e=0,p,c=$('<li class="app-calendar-month-more"><\/li>');for(v=!1,y.empty().data("calendar-event-count",d);e<5;){if(r=k.rows[e],!r)break;var lt=r[0],t=r[1],g=r[2],ut=r[3],nt=r[4],ft=f(t,!1,!0);g&&(ft+="-"+f(g,!1,!0));var at=String.format('<span class="app-event-time">{0}<\/span> {1}',ft,nt?nt:o.Data.NullValueInForms),u=$('<li class="app-event"><\/li>').data("data-context",r),vt=s.getEventTitle(t,g,nt,ut),yt=s.activeCalendar.colorMap.className(ut);if(tt.get_isTagged("calendar-drag-disabled")||u.attr("data-draggable","calendar-event"),h||(h=t),w&&w==lt&&(u.addClass("app-calendar-selected"),p=u),u.addClass(yt),u.html(at),u.attr("title",vt),u.appendTo(y),e++,y.height()>it&&d!=1){u.remove();v=!0;e--;break}}(v||e<k.count)&&(c.appendTo(y),v&&(et=c.prev(),et.length&&(c.prev().remove(),e--)),c.html(String.format(ru,d-e)),w&&a&&a.getDate()==h.getDate()&&a.getMonth()==h.getMonth()&&a.getFullYear()==h.getFullYear()&&(p&&(!p||p.is(":visible"))||c.addClass("app-calendar-selected")))}},getNextDate:function(n,i){var u=this.calendar,e=u.getMostVisibleBlock(),r=t(e),n,f;return r.setMonth(r.getMonth()+i),n=u.getVisibleView(),f=u.getBlockByDate(n,r),f.length||(i==1?n.find(".dv-load-at-bottom").trigger("vclick"):n.find(".dv-load-at-top").trigger("vclick")),r},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-monthview > .app-calendar-month")}};di=function(n){this.calendar=n};di.prototype={draw:function(n,t){var r,h,f,l;n.find(".app-calendar-yearview").remove();var i=$('<div class="app-calendar-yearview"><\/div>').hide().appendTo(n),u=i.closest(".app-echo").length>0,e=u?0:y.year,o=t.getFullYear(),s=$('<div class="app-calendar-load-at-top"><\/div>').appendTo(i),a=$('<a href="#" class="dv-load-at-top ui-btn"/>').appendTo(s).text(c.Loading);for(u&&s.hide(),r=o-e;r<=o+e;r++)h=this.drawYear(new Date(r,0)).appendTo(i);return i.fadeIn("fast"),f=$('<div class="app-calendar-load-at-bottom"><\/div>').appendTo(i),l=$('<a href="#" class="dv-load-at-bottom ui-btn">Load more<\/a>').appendTo(f).text(c.Loading),u&&f.hide(),this.scroll({view:i,date:t}),i},showHeaderAndFooter:function(n,t){n.find(".app-day-header").hide();n.find(".app-week-header").hide();n.find(".app-month-header").hide();$app.touch.bar("hide",t)},drawYear:function(n){for(var h,r,u,o,s,f=n.getFullYear(),e='<div class="app-calendar-year" data-cal-year="'+f+'"><h1>'+f+"<\/h1>",t=0;t<=11;t++){for(h=i.AbbreviatedMonthNames[t].toUpperCase(),r='<div class="app-calendar-month" data-cal-month="'+t+'"><a class="ui-btn app-calendar-month-header">'+h+"<\/a><table><thead>",u=0;u<7;u++)r+="<th>"+i.ShortestDayNames[st[u]].substr(0,1)+"<\/th>";r+="<\/thead><tbody>";r+=vr(f,t);e+=r+"<\/tbody><\/table><\/div>"}return e+='<div class="app-clear-fix"><\/div><\/div>',o=$(e),s=this.calendar.cache.select(n),s&&this.addData(null,n,s,o.addClass("data-loaded")),o},addData:function(n,t,i,r){var f=this.calendar,e=r||f.getBlockByDate(n,t,"year"),u,o,s;e.find("td.app-has-data").removeClass("app-has-data").attr("title",null);for(u in i)o=i[u],s=e.find('div[data-cal-month="'+u+'"]'),s.find("td").each(function(){var t=$(this),i=t.text(),n;i.trim().length&&(n=o[i],n&&n.count&&t.addClass("app-has-data").attr("title",String.format("{0} ({1})",f.activeCalendar.date.Label,n.count)))})},scroll:function(t){function o(){n.fetchOnDemand();u.updateHeader(l);ut(i)}var s=this,h=t.date,u=s.calendar,i=u.scrollable(),c=t.view.closest("div.app-presenter"),l=c.data("cal-header"),r=u.getBlockByDate(t.view,t.date),e,f;r&&(r=r.find('div.app-calendar-month[data-cal-month="'+h.getMonth()+'"]'),e=i.find(".app-presenter-instruction"),f=r.offset().top+i.scrollTop()-i.offset().top-e.outerHeight(),t.animate?n.animatedScroll(i,f,o):(n.scroll(i,f),o()))},clear:function(n){var r=this.calendar.scrollable(),i=r.find(".app-calendar-yearview"),t;i.length&&(t=i.find("div.app-calendar-year.data-loaded"),t.removeClass("data-loaded").removeData("calendar-colors"),n&&t.find(".app-has-data").removeClass("app-has-data").attr("title",null))},resize:function(n){this.calendar.navigateDate&&this.scroll({view:n,date:this.calendar.navigateDate})},getNextDate:function(n,i){var u=this.calendar,e=u.getMostVisibleBlock(),r=t(e),n,f;return r.setYear(r.getFullYear()+i),n=u.getVisibleView(),f=u.getBlockByDate(n,r),f.length||(i==1?n.find(".dv-load-at-bottom").trigger("vclick"):n.find(".dv-load-at-top").trigger("vclick")),r},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-yearview > .app-calendar-year")}};gi=function(n){this.calendar=n};gi.prototype={draw:function(n,t){var i=n.find(".app-calendar-agendaview");i.length||(i=$('<div class="app-calendar-agendaview"><\/div>').appendTo(n));var r=this,f=this.calendar,p=f.activeCalendar,w=f.dataView,l=i.closest(".app-echo").length>0,e=new Date(t),u=i.find(".app-calendar-agenda-list"),v=u.length&&i.is(".data-loaded"),y=i.closest(".app-wrapper"),a=y.find(".app-presenter-instruction"),o=i.find(".app-calendar-load-at-top"),s=i.find(".app-calendar-load-at-bottom"),h=i.find(".app-echo-footer");return l?i.height(f.echoMaxHeight):a.css("visibility","hidden"),v||(u.length||(u=$('<ul class="app-calendar-agenda-list"><\/ul>').hide().appendTo(i)),l?h.length||(h=$('<div class="app-echo-footer"><div class="app-echo-container-see-all"><a class="ui-btn-icon-left ui-btn ui-icon-carat-r dv-action-see-all"/><\/div><\/div>').hide().appendTo(i)):(o.length||(o=$('<div class="app-calendar-load-at-top"><\/div>').hide().prependTo(i),$('<a href="#" class="dv-load-at-top ui-btn"/>').text(c.Loading).appendTo(o)),s.length||(s=$('<div class="app-calendar-load-at-bottom"><\/div>').hide().appendTo(i),$('<a href="#" class="dv-load-at-bottom ui-btn"><\/a>').text(c.Loading).appendTo(s)))),f.cache.clearAgenda(),r.minPage=0,r.maxPage=0,r.todayLoaded=!1,r.lastDate=e,r.loadData(i,e,0,function(n,f){r.loadData(i,e,-1,function(c,v){var y;u.empty();var it={"0":n["0"],"-1":c["-1"]},w=r.drawData(i,e,it),b=r.calendar.cache.select(1),k=r.calendar.cache.select(-2);if(u.show(),i.fadeIn("fast").css("height",""),l){var d=w[0],rt=w[1],g=f+v,nt=d+rt,p=v-d+1,tt=p+nt-1;nt!=g&&(y=h.find(".dv-action-see-all"),y.empty(),h.show(),$('<span class="app-btn-see-all"/>').appendTo(y).text(ft.SeeAll).attr("title",ft.SeeAll),$('<span class="app-info"/>').appendTo(y).attr({"data-start-index":p,"data-end-index":tt}).html(String.format(ti.ShowingItems,p,tt,g)))}else a.css("visibility",""),b&&b.length==0||s.show(),k&&k.length==0||o.show(),r.scroll({view:i,date:t})})}),i},showHeaderAndFooter:function(n,t){n.find(".app-day-header").hide();n.find(".app-week-header").hide();n.find(".app-month-header").hide();$app.touch.bar("hide",t)},getNextDate:function(n,i){var u=this.calendar.scrollable(),s=u.scrollTop(),f=this.calendar.getFirstVisibleBlock(u),h=n.find(".app-calendar-agenda-list li:not(.app-calendar-month-header)").first(),e,o,r;return t(f).getTime()==t(h).getTime()?(e=n.find(".dv-load-at-top"),e.is(":visible")&&e.trigger("vclick")):i==1&&s+u.height()>u[0].scrollHeight-20&&(o=n.find(".dv-load-at-bottom"),o.is(":visible")&&o.trigger("vclick")),r=i==1?f.next():f.prev(),r.is(".app-calendar-month-header")&&(r=i==1?r.next():r.prev()),r.length?t(r):t(f)},scroll:function(i){var s=this.calendar,f=i.view||s.getVisibleView(),e=i.date,o;if(!f.hasClass("data-loaded")){this.draw(f.closest(".app-calendar"),e);return}var u=s.scrollable(),l=f.closest(".app-presenter"),y=l.data("cal-header"),r=s.getBlockByDate(f,e),h=this.getBlocks().first(),a=t(h),v=u.find(".app-presenter-instruction");if(r.length)r=r.closest(".app-agenda-day-list");else for(r=h;r.length&&t(r)<=e;)r=r.next(),r.is(".app-calendar-month-header")&&(r=r.next());if(r.length){function c(){n.fetchOnDemand();ut(u)}o=0;li(e,a)||(o=u.scrollTop()+r.offset().top-u.offset().top-v.height());i.animate?n.animatedScroll(u,o,c):(n.scroll(u,o),c())}},resize:function(n){this.calendar.navigateDate&&this.scroll({view:n,date:this.calendar.navigateDate})},clear:function(n){n||(n=this.calendar.getViews().filter(".app-calendar-agendaview"));n.removeClass("data-loaded");n.find(".app-calendar-load-at-top, .app-calendar-load-at-bottom").hide();this.todayLoaded=!1;this.calendar.cache.clearAgenda()},loadData:function(n,t,i,r){var c;t||(t=this.lastDate);var f=this,u=f.calendar,s=u.activeCalendar,e=u.dataView,y=n.closest(".app-echo").length>0,p=n.find(".app-calendar-agenda-list"),h=i<0,a=h?ht(e,s.date,s.end,null,t):ht(e,s.date,s.end,t,null),v=s.date.Name+(h?" desc":" asc"),o={},l=i>=0?i:Math.abs(i)-1;i>f.maxPage?f.maxPage=i:i<f.minPage&&(f.minPage=i);c=u.cache.select(i);c?(o[i]=c,r?r(o):f.drawData(n,t,o)):(u.loadingData=!0,$app.execute({controller:e._controller,view:e._viewId,command:"Select",_filter:a,sort:v,pageSize:kt*2,pageIndex:l/2,requiresRowCount:!0,tags:e.get_tags(),success:function(s){var v,y,c,a;(u.loadingData=!1,v=s[e._controller],y=s.totalRowCount<=(l+1)*kt*2,u.mode=="agenda")&&(c=v.splice(0,kt),a=v,h?(c.reverse(),a.reverse(),u.cache.insert(i,c),u.cache.insert(i-1,a),y&&u.cache.insert(i-2,[])):(u.cache.insert(i,c),u.cache.insert(i+1,a),y&&u.cache.insert(i+2,[])),o[i]=c,r?r(o,s.totalRowCount):f.drawData(n,t,o,s.totalRowCount))},error:function(n){u.loadingData=!1;$app.alert(String.format("{0}",n.get_message()))}}))},drawData:function(t,r,u){function bt(n,t){var w=k&&n[k.Name],r=n[ui],u=n[yt],s=pt&&n[pt],y=st&&n[st],b=e.colorMap.className(y),p=a.getDayList(h,r,t?"prepend":"append"),i=$("<li><\/li>").attr("data-cal-page",et),d=$('<span class="app-event-time"><\/span>').appendTo(i),l=f(r),v=$('<div class="app-event"><\/div>').text(u?u:o.Data.NullValueInForms).data("data-context",n).appendTo(i);return v.attr("title",c.getEventTitle(r,s,u,y)).addClass(b),tt&&tt==w&&v.addClass("app-calendar-selected"),s&&(l+=" - "+f(s)),d.text(l),$('<div class="app-event-time"><\/div>').text(l).appendTo(v),t?i.prependTo(p):i.appendTo(p),i}var a=this,c=a.calendar,h=t.find(".app-calendar-agenda-list"),ii=c.scrollable(),ri=t.closest(".app-echo").length>0,e=c.activeCalendar,vt=c.dataView,ui=e.date.Name,yt=e.text.Name,st=e.color&&e.color.Name,pt=e.end&&e.end.Name,k=c.dataView._keyFields[0],wt=c.dataView.extension().commandRow(),tt=wt?wt[k.Index]:null,it=c.getMostVisibleBlock(),fi=it?it.position().top:0,v,ht,lt,at,et,nt,ot,l,y,gt;if(e.text.AliasName&&e.text.AliasName.length&&(v=vt.findField(e.text.AliasName),v&&(yt=v.Name)),e.color&&e.color.AliasName&&e.color.AliasName.length&&(v=vt.findField(e.color.AliasName),v&&(st=v.Name)),ri){for(var y=a.calendar.cache.select(0),l=a.calendar.cache.select(-1),ei=l.length&&l[0][k.Name],p=0,d=0,b=!0,rt=!0,dt=c.echoMaxHeight-t.find(".app-echo-footer").height(),oi=y.length+l.length,g=0,s,ut;(h.outerHeight(!0)<dt||g<3)&&g<oi;){if(y.length<=p&&(b=!1),l.length<=d){if(y.length<=p)break;b=!0;rt=!1}ht=b&&!rt?y[p++]:l[d++];ht?(g++,bt(ht,!b)):(b?p--:d--,b=!1);rt&&(rt=!1)}a.validateToday(h,h.children(),r);s=h.find(".app-agenda-day-list:first");ut=s.attr("data-cal-year");s.length&&ut!=(new Date).getFullYear().toString()&&$("<h1/>").appendTo($('<li class="app-calendar-month-header" data-cal-year="'+ut+'" data-cal-month="'+s.attr("data-cal-month")+'"/>').insertBefore(s)).text(ut);for(var ct=!1,s=h.find("li.app-agenda-day-list").first(),ft=s.find("li").first();h.outerHeight(!0)>dt&&g>3;)lt=ft.find(".app-event").data("data-context"),at=lt&&lt[k.Name],tt&&(at==tt||at==ei)?ct=!0:(ft.remove(),g--,s.find("li").length==0&&(s.remove(),ct?p--:d--)),ct?(s=h.find("li.app-agenda-day-list").last(),ft=s.find("li").last()):(s=h.find("li.app-agenda-day-list").first(),ft=s.find("li").first());return[d,p]}for(et in u)if(nt=u[et],ot=et<0,nt.length<kt&&(l=t.find(".app-calendar-load-at-top"),y=t.find(".app-calendar-load-at-bottom"),ot?l.hide():y.hide()),nt.length>0)for(gt in nt)bt(nt[gt],ot);var ni=c.getBlocks(),ti=[],si=w.getFullYear();ni.each(function(){var f=$(this),r=f.attr("data-cal-year"),u=f.attr("data-cal-month"),e=r+"-"+u,n;if(ti[e])return!0;for(monthHeader=t.find(String.format('li.app-calendar-month-header[data-cal-year="{0}"][data-cal-month="{1}"]',r,u)),monthHeader.length||(monthHeader=$(String.format('<li class="app-calendar-month-header ui-btn" data-cal-year="{0}" data-cal-month="{1}"><h1>{2}<\/h1><\/li>',r,u,i.MonthNames[u])).insertBefore(f),r!=si&&monthHeader.find("h1").text(i.MonthNames[u]+" "+r)),n=f.prev();n.length;){if(n.attr("data-cal-year")!=r||n.attr("data-cal-month")!=u){monthHeader.insertBefore(n.next());break}n=n.prev()}ti[e]=!0});a.validateToday(h,ni,r);t.addClass("data-loaded");it&&ot&&n.scroll(ii,it.position().top-fi)},validateToday:function(n,i,r){var e,v,h;if(!this.todayLoaded){var c=i.first(),y=c.length?t(c):r,l=i.last(),p=l.length?t(l):r,w=y<et&&et<p,u,s;if(w||k(r)){if(this.todayLoaded=!0,e=this.getDayList(n,et,"search"),e.find(".app-time-line-container").length)return;var b=e.parents("li[data-cal-year]"),a=new Date,o=$('<li class="app-time-line-container"><\/li>').appendTo(e),d=$('<span class="app-event-time"><\/span>').text(f(a)).appendTo(o);for(timeLine=$('<div class="current-time-line"><div class="dot">&nbsp;<\/div><\/div>').appendTo(o),b.addClass("app-has-current-day"),u=o.prev();u.length;){if(v=u.find(".app-event"),h=v.data("data-context"),h&&h[this.calendar.activeCalendar.date.Name]>a)s=u;else break;u=u.prev()}s&&o.insertBefore(s)}}},removeData:function(n,t){n.find('.app-calendar-agenda-list li[data-cal-page="'+t+'"]').remove();t==this.maxPage?(n.find(".app-calendar-load-at-bottom .ui-btn").addClass("dv-load-at-bottom").text(c.Loading).show(),this.maxPage--):t==this.minPage&&(n.find(".app-calendar-load-at-top .ui-btn").addClass("dv-load-at-top").text(c.Loading).show(),this.minPage++);this.removeEmptyRows(n)},getDayList:function(n,r,u){var s=this.calendar.getBlockByDate(n,r),e,y,l,h;if(!s.length){var f=$('<li class="app-agenda-day-list"><\/li>').attr("data-cal-year",r.getFullYear()).attr("data-cal-month",r.getMonth()).attr("data-cal-day",r.getDate()),a=i.AbbreviatedDayNames[r.getDay()],p=$(String.format('<h2 class="ui-btn"><span class="app-calendar-daynumbig">{2}<\/span><span class="app-calendar-dayname">{0}<\/span> <span class="app-calendar-monthname">{1}<\/span> <span class="app-calendar-daynum">{2}<\/span><\/h2>',a,i.AbbreviatedMonthNames[r.getMonth()],r.getDate())).appendTo(f).attr("title",String.format("{0:"+i.LongDatePattern+"}",r)),v=$('<div class="app-calendar-day"><\/div>').appendTo(f),o=new Date,c=new Date;if(o.setDate(o.getDate()-1),c.setDate(o.getDate()+1),k(r)?f.addClass("app-calendar-agenda-today"):li(r,o)?f.addClass("app-calendar-agenda-yesterday"):li(r,c)&&f.addClass("app-calendar-agenda-tomorrow"),u=="prepend")f.prependTo(n);else if(u=="append")f.appendTo(n);else{for(e=n.find("li[data-cal-year]:first"),h=!1;e.length;){if(l=t(e),r<l){f.insertBefore(e);h=!0;break}y=e;e=e.next()}h||f.appendTo(n)}s=$("<ul><\/ul>").appendTo(v);b(f)}return s},removeEmptyRows:function(n){n.find(".app-calendar-agenda-list > li").each(function(){var i=$(this),e=i.is(".app-calendar-month-header"),r=t(i),u,f;e?(u=n.find(String.format('li[data-cal-year="{0}"][data-cal-month="{1}"][data-cal-day]',r.getFullYear(),r.getMonth())),u.length==0&&i.remove()):(f=i.find("ul .app-event"),f.length==0&&i.remove())})},getBlocks:function(){var n=this.calendar.scrollable();return n.find(".app-calendar-agendaview > .app-calendar-agenda-list > li:not(.app-calendar-month-header)")}};$app.touch.presenter("register",{name:"calendar",icon:function(){return"calendar"},text:function(){return r.Text},supports:pr,show:function(n){var t=$app.find(n.id);t&&t.calendar&&t.calendar.show(n)},hide:function(t){var i=n.dataView();i&&i.calendar&&i.calendar.hide(t)},dispose:function(t){var i=n.dataView();i&&i.calendar&&(i.calendar.dispose(t),delete i.calendar)}});h=n.CalendarInput=function(t,i){function k(n){var t=$(n.target);t.closest('.app-input-text, .app-calendar-plugin-container, [data-field="'+p+'"]').length||(at.off("mousedown",k),h("hide",{container:r}))}function rt(n,t){var i={NewValue:t};return n._validateFieldValueFormat(e,i,!0),i.NewValue}function v(n,t,i,r){var u=nt(r),f=u?t.format(r):"";u||t.AllowNulls||(r=new Date,f=t.format(r));a||!i||i.parent().length==0?$app.input.execute({dataView:n,values:[{name:t.Name,value:r}]}):$app.input.value(f)}function ut(){r.hide().removeData("select-date");$(".app-calendar-cover").hide()}var r=i.container,f=i.input,c=i.dataView=i.dataView||f&&$app.find(f.closest("[data-input-container]").attr("data-input-container"))||n.dataView(),it=c._id,o=r&&r.data("data-input"),e=i.field=i.field||o&&$app.input.elementToField(o),p=e&&e.Name,a=$app.touch.pointer()=="touch",s,w,b,d,y,l,g;if(f&&f.length){if(!f.parent().length&&!a){alert("TODO: input is detached!");return}if(s=f.closest(".app-wrapper"),r||(r=s.find(".app-calendar-plugin-container")),r.length||(r=$('<div class="app-calendar-plugin-container app-data-input-helper"><\/div>').hide().appendTo(s)),$('<div class="app-calendar-cover" style="display:none"><\/div>').appendTo(s),i.container=r,o=f.closest("[data-input]"),i.field=e=$app.input.elementToField(o),p=e.Name,r.data("data-input",o),e.tagged("calendar-input-disabled"))return!0;if(w=e.DataFormatString=="{0:t}"||e.DataFormatString=="{0:T}",i.showTime=!!(e.TimeFmtStr||w),i.hideDate=w,e.tagged("calendar-input-future")&&(i.limitStart=new Date,i.limitStart.setHours(0,0,0,0)),nt(i.date)||(t=="clear"?(v(i.dataView,e,f,""),i.date=new Date,t="setDate"):(i.date=c.convertStringToFieldValue(e,f.val()),nt(i.date)||(i.date=new Date))),i.onselect=function(n){if(n.target.closest(".app-month-container").length&&(r.find(".app-month-container .app-selected").removeClass("app-selected"),ni(r,n.date).addClass("app-selected"),tt()),r.data("select-date",n.date),!r.find(".app-calendar-action-bar:visible").length){var t=n.dataView.findField(p);t&&(v(n.dataView,t,f,n.date),n.endField&&(!t.TimeFmtStr||n.oldTimeMode=="Minute"&&n.target.closest(".app-time-selector").length)&&setTimeout(function(){f.blur();$app.input.execute({dataView:c,values:[{name:n.endField,value:n.date}]});setTimeout(function(){s.find(String.format('[data-field="{0}"]',n.endField)).first().trigger("vclick")},10)},250))}},i.onrefresh=function(n){n.monthContainer.find(".app-selected").removeClass("app-selected");var t=n.container.data("select-date")||n.date;nt(t)&&ni(n.monthContainer,t).addClass("app-selected")},i.attachCallbacks=!0,!f.attr("data-datepicker-attached")){f.attr("data-datepicker-attached","true").focus(function(){var n,t,o=r.height(),h=r.width(),c=s.width(),l=s.height(),u=s.scrollTop(),e=a,v=$(".app-calendar-cover");if(br.width()<640)n=u+(l-o)/2,t=(c-h)/2,e=!0;else{var y=f.offset(),p=s.offset(),w=f.outerHeight();n=y.top-p.top+u+f.outerHeight();t=y.left-p.left;(kr||n+o>l+u)&&(n-=o+w,n<u&&(n=u+10,e=!0));t+h>c&&(t=c-h-10)}r.css({top:n,left:t});r.data("select-date",i.date);e?(r.addClass("app-calendar-touch"),v.show()):(r.removeClass("app-calendar-touch"),v.hide());a?r.stop(!0).fadeIn("fast"):r.show();(e||a)&&f.blur()}).on("input",function(){var n=$app.find(it),t=rt(n,f.val());nt(t)&&h("setDate",{input:f,date:t,dataView:n,container:r})}).on("remove.input.app",function(){r.is(".app-calendar-touch")||(h("hide",{container:r}),r.removeData("select-date"))});at.on("mousedown",k)}}if(i.renderTime=!0,i.excludeKeyFieldsFromFilter=!0,i.queryData=function(n,t){return n&&n.tagged("calendar-input-data-none")?!1:n&&n.Name!=t||!n&&t?!1:!0},i.limitStart=!1,e)for(b=c.calendar&&c.calendar.calendars||vi(c),d=b.length,y=0;y<d;y++)l=b[y],l.end&&(e.Name==l.date.Name?i.endField=l.end.Name:e.Name==l.end.Name&&(i.startField=l.date.Name,g=c.editRow(),i.limitStart=new Date(g[l.date.Index]),i.limitStart.setHours(0,0,0,0)));switch(t){case"setInput":v(i.dataView,$app.input.elementToField(o),o.find("input"),i.date);break;case"clear":v(i.dataView,$app.input.elementToField(o),o.find("input"));break;case"hide":ut();break;case"attach":return u(t,i),!a;default:return u(t,i)}};u=function(u,f){function ti(){return v.calendar?v.calendar.activeCalendar:vi(v)[0]}function ii(n){return[i.MonthNames[n.getMonth()]+" "+n.getFullYear(),i.AbbreviatedMonthNames[n.getMonth()]+" "+n.getFullYear()]}function ri(n){return c.find(String.format('.app-scroll-column > div[data-cal-year="{0}"][data-cal-month="{1}"]',n.getFullYear(),n.getMonth()))}function wt(){var n=t(c);return a.closest(".app-calendar-show-time").length&&ct(y,n),n}function ui(n,t,r){var e,u,h,o,f,s;for(n.empty(),e="<table><thead>",r&&(u=$("<div><\/div>").appendTo(n),h=ii(t),u.text(h[0]),u[0].scrollWidth>u.innerWidth()&&u.text(h[1])),o=0;o<7;o++){var c=st[o],l=i.ShortestDayNames[c],a=i.DayNames[c];e+='<th title="'+a+'">'+l+"<\/th>"}e+="<\/thead><tbody>"+vr(t.getFullYear(),t.getMonth(),!0)+"<\/tbody><\/table>";f=$(e).appendTo(n);n.is(".app-first-month")||f.find("td.app-prev-month").addClass("app-day-hidden");n.is(".app-last-month")||f.find("td.app-next-month").addClass("app-day-hidden");f.find("tr").filter(function(){return!$(this).find("td:not(.app-day-hidden), th").length}).addClass("app-week-hidden");s=f.find("td.app-current-day");s.length&&s.html('<span class="app-current-day">'+s.text()+"<\/span>");d(n,t)}function bt(n,t,i){$(i).each(function(){var r=this[1],i=this[0];if(r&&r!=0){i.indexOf(", ")<0&&(i=i+", "+i);var u=/(\d+), (\d+)/.exec(i),f=parseInt(u[1],10)-1,e=u[2],o=new Date(t.getFullYear(),f,e),s=ni(n,o);s.addClass("app-has-data").attr("title",String.format("{0} ({1})",w.Label,r))}})}function kt(n,t,r){var h=new Date(t),u,p,e,w;lt(n,h);var c=n.find(".app-hour-selector").hide(),l=n.find(".app-minute-selector").hide(),b=l.find("li"),o=eu(h),a=n.find(".app-time-hour"),v=n.find(".app-time-minute"),k=n.find(".app-time-ampm"),s=n.find(".app-time-hand").removeClass("app-inner-ring app-dot"),f=0,y=i.AMDesignator=="";a.text(o.hour);v.text(o.minute);n.find(".app-cal-selected").removeClass("app-cal-selected");switch(r){case"Hour":a.addClass("app-cal-selected");c.show();u=t.getHours();y?u<12&&s.addClass("app-inner-ring"):u>=12&&(u-=12);f=u*30;p=c.find("li");p.eq(u).addClass("app-cal-selected");break;case"Minute":v.addClass("app-cal-selected");l.show();e=t.getMinutes();f=e*6;e%5!=0?s.addClass("app-dot"):b.eq(e/5).addClass("app-cal-selected")}f>360&&(f-=360);s.css("transform","rotate("+f+"deg)");y||(w=k.find("span"),w.eq(o.ampm==i.AMDesignator?0:1).addClass("app-cal-selected"))}function ut(){function oi(n,t){return s.is(":visible")?vt.activePage.attr("id")!=ai?!0:f.queryData&&!f.queryData(n,t)?!0:!1:!0}var hi=c.find(".app-scroll-inner"),g=c.find(".app-scroll-column > div"),pt=t(g.eq(it)),nt=wt(),ci=h.getMonth(),r=a.find(".app-calendar-plugin-header div"),vi=r.text(),li=$.mobile.activePage.find(".app-wrapper"),dt=li.find(".app-calendar"),yi=dt.length&&dt.is(":visible"),ni=l.find(".app-scroll-inner"),n=new Date(h),ti=f.reloadData,st,ii,lt,u,o;switch(p){case"":r.html(String.format(ar,i.MonthNames[h.getMonth()],h.getFullYear(),i.MonthNames[h.getMonth()],h.getFullYear()));st=r.find("a");ii=st.first().outerWidth()+st.eq(2).outerWidth();ii>r.innerWidth()-60&&r.html(String.format(ar,i.MonthNames[n.getMonth()],h.getFullYear(),i.AbbreviatedMonthNames[n.getMonth()],h.getFullYear()));(h.getFullYear()!=pt.getFullYear()||h.getMonth()!=pt.getMonth())&&(ti=!0,n.setMonth(n.getMonth()-it),g.each(function(){var t=$(this);ui(t,n,!t.is(".app-first-month"));n.setMonth(n.getMonth()+1)}));et||f.limitEnd?g.each(function(){var i=$(this),n=t(i);i.find("td").filter(function(){var t=new Date(n),i=$(this);return(t.setMonth(i.closest("[data-cal-month]").attr("data-cal-month"),i.attr("data-cal-day")),i.is(".app-prev-month")?t.setMonth(n.getMonth()-1):i.is(".app-next-month")&&t.setMonth(n.getMonth()+1),et&&t<et)?!0:f.limitEnd&&t>f.limitEnd?!0:!1}).addClass("app-day-unselectable")}):g.find(".app-day-unselectable").removeClass("app-day-unselectable");function ri(){hi.css("marginLeft","")}k&&k!=""?gt(l,c,null,ri):ri();setTimeout(function(){var n=a.height();n>0&&a.height(n)});break;case"selectmonth":r.html(String.format('<a class="ui-btn app-year-picker">{0}<\/a>',n.getFullYear()));n.setFullYear(n.getFullYear()-1);u=Math.floor(c.height()/3)-10;function ct(){l.find(".app-scroll-column").each(function(){var r=$(this).empty(),t,f;for(d(r,n),t=0;t<12;t++)f=$(String.format('<div class="app-select-month ui-btn" data-cal-month="{0}" title="{2}">{1}<\/div>',t,i.AbbreviatedMonthNames[t],i.MonthNames[t])).css({height:u,lineHeight:u+"px"}).appendTo(r),nt.getMonth()==t&&nt.getFullYear()==n.getFullYear()&&f.addClass("app-selected");b(r);n.setFullYear(n.getFullYear()+1)});ni.css("marginLeft","")}k&&k!=""?k=="selectyear"?gt(l,l,ct):ct():gt(c,l,ct);break;case"selectyear":lt=n.getFullYear();r.html(String.format("<span>{0} - {1}<\/span>",lt,lt+11));n.setFullYear(n.getFullYear()-12);u=Math.floor(c.height()/3)-10;function fi(){l.find(".app-scroll-column").each(function(){var t=$(this).empty(),r,i;for(d(t,n),i=0;i<12;i++)r=$(String.format('<div class="app-select-year ui-btn" data-cal-year="{0}">{0}<\/div>',n.getFullYear())).css({height:u,lineHeight:u+"px"}).appendTo(t),n.getFullYear()==nt.getFullYear()&&r.addClass("app-selected"),n.setFullYear(n.getFullYear()+1);b(t)});ni.css("marginLeft",-a.width())}k!="selectyear"?gt(l,l,fi):fi()}ot&&kt(y,h,tt);var ei=s.data("calendar-onrefresh"),ai=vt.activePage.attr("id"),at=w&&w.Name;if(ei&&ei({container:s,monthContainer:c,selectorContainer:l,timeContainer:y,dataView:v,mode:p,date:nt,startField:f.startField,endField:f.endField}),ti&&!f.hideDate&&!v._survey){var ut=new Date(h.getFullYear(),h.getMonth()),si=String.format("{0}-{1}",ut.getFullYear(),ci),ft=rt[w.Name],yt=c.find(".app-scroll-column").eq(1);yt.find(".app-has-data").removeClass("app-has-data").attr("title","");ft||(ft=rt[w.Name]={});o=ft[si];o?bt(yt,ut,o):(clearTimeout(ur),ur=setTimeout(function(){if(!oi(w,at)){var u=[at],n=new Date(ut),i=e[n.getDay()],t,r={},f=v._keyFields.map(function(n){return n.Name});i!=0&&n.setDate(n.getDate()-i);t=new Date(n);t.setDate(t.getDate()+7+35*it);t.setSeconds(-1);r[w.Name]=["pivot-row1-month-raw","pivot-row2-day"];$app.execute({controller:v._controller,command:"Pivot",view:v._viewId,_filter:ht(v,w,null,n,t,f),fieldFilter:u,sort:"",pivotDefinitions:r,tags:v.get_tags(),success:function(n){var t=n.Pivots.pivot0;t&&(o=ft[si]=n.Pivots.pivot0.Data.slice(1),v.session("calendar-input-cache",rt),oi(w,at)||bt(yt,ut,o))},error:function(n){$app.alert(String.format("{0}",n.get_message()))}})}},300))}return a}function fi(){var ri=v.extension().commandRow(),nt=!a.length,pt,n;if(nt){a=$('<div class="app-calendar-plugin"><\/div>').prependTo(s);var rt=$('<div class="app-calendar-plugin-header"><div>&nbsp;<\/div><\/div>').appendTo(a),ui=$('<a href="#" class="app-calendar-plugin-loadleft ui-btn ui-btn-corner-all ui-btn-icon-notext ui-icon-carat-l"><\/a>').attr("title",o.Pager.Previous).prependTo(rt),fi=$('<a href="#" class="app-calendar-plugin-loadright ui-btn ui-btn-corner-all ui-btn-icon-notext ui-icon-carat-r"><\/a>').attr("title",o.Pager.Next).appendTo(rt),ct=new Date(h);c=$('<div class="app-month-container" data-draggable="calendar-mini"><\/div>').appendTo(a);var u=$('<div class="app-scroll-inner"><\/div>').appendTo(c),at=$('<div class="app-scroll-column"><\/div>').appendTo(u),vt=$('<div class="app-scroll-column"><\/div>').appendTo(u),yt=$('<div class="app-scroll-column"><\/div>').appendTo(u);if(l=$('<div class="app-date-selector-container" data-draggable="calendar-mini" style="display:none"><\/div').appendTo(a),pt=$('<div class="app-scroll-inner"><div class="app-scroll-column"><\/div><div class="app-scroll-column"><\/div><div class="app-scroll-column"><\/div><\/div>').appendTo(l),f.renderTime){y=$('<div class="app-time-container"><div class="app-time-header"><span class="app-time-hour app-cal-selected">12<\/span>:<span class="app-time-minute">00<\/span> <span class="app-time-ampm"><\/span><\/div> <div class="app-time-selector" data-draggable="calendar-mini-hand"><div class="app-hour-selector"><ul class="app-hour-list">'+(i.AMDesignator==""?"<li>00<\/li><li>1<\/li><li>2<\/li><li>3<\/li><li>4<\/li><li>5<\/li><li>6<\/li><li>7<\/li><li>8<\/li><li>9<\/li><li>10<\/li><li>11<\/li><li>12<\/li><li>13<\/li><li>14<\/li><li>15<\/li><li>16<\/li><li>17<\/li><li>18<\/li><li>19<\/li><li>20<\/li><li>21<\/li><li>22<\/li><li>23<\/li>":"<li>12<\/li><li>1<\/li><li>2<\/li><li>3<\/li><li>4<\/li><li>5<\/li><li>6<\/li><li>7<\/li><li>8<\/li><li>9<\/li><li>10<\/li><li>11<\/li>")+'<\/ul><\/div><div class="app-minute-selector" style="display: none"><ul class="app-minute-list"><li>00<\/li><li>05<\/li><li>10<\/li><li>15<\/li><li>20<\/li><li>25<\/li><li>30<\/li><li>35<\/li><li>40<\/li><li>45<\/li><li>50<\/li><li>55<\/li><\/ul><\/div><span class="app-time-hand app-transition"><span><\/span><\/span><\/div><\/div>').appendTo(s);var wt=y.find(".app-time-selector"),et=y.find(".app-time-ampm"),t=wt.height()/2,e=t*.815,bt=i.AMDesignator==""?t*.55:e,kt=y.find(".app-hour-list li"),gt=y.find(".app-minute-list li"),ni=i.AMDesignator?12:24;for(n=0;n<ni;n++){var ti=kt.eq(n),k=n*30/57.2958-Math.PI/2,st=n>=12?e:bt,ht={top:t+st*Math.sin(k),left:t+st*Math.cos(k)};ti.css(ht)}for(n=0;n<12;n++){var ii=gt.eq(n),k=n*30/57.2958-Math.PI/2,ht={top:t+e*Math.sin(k),left:t+e*Math.cos(k)};ii.css(ht)}i.AMDesignator?et.html("<span>"+i.AMDesignator+"<\/span><br/><span>"+i.PMDesignator+"<\/span>"):et.hide();f.hideActionBar||(dt=$('<div class="app-calendar-action-bar"><a class="ui-btn ui-corner-all ui-mini ui-btn-inline app-calendar-btn-ok">'+o.ModalPopup.OkButton+'<\/a><a class="ui-btn ui-corner-all ui-mini ui-btn-inline app-calendar-btn-cancel">'+o.ModalPopup.CancelButton+'<\/a><a class="ui-btn ui-corner-all ui-mini ui-btn-inline app-calendar-btn-clear"/><\/div>').appendTo(s))}h.setMonth(h.getMonth()-it);function g(n){for(var i,t=0;t<it;t++)i=$("<div><\/div>").appendTo(n),t==0&&i.addClass("app-first-month"),t==it-1&&i.addClass("app-last-month"),h.setMonth(h.getMonth()+1)}g(at);g(vt);g(yt);b(u);h=ct}return s.find(".app-calendar-btn-clear").text(w.AllowNulls?ft.LookupClearAction:r.Today),ot?s.addClass("app-calendar-show-time"):s.removeClass("app-calendar-show-time"),f.hideDate?s.addClass("app-calendar-hide-date"):s.removeClass("app-calendar-hide-date"),d(c,h),lt(y,h),(f.attachCallbacks||nt)&&(f.onrefresh&&s.data("calendar-onrefresh",f.onrefresh),f.onselect&&s.data("calendar-onselect",f.onselect),s.data("calendar-show-months",it),p="",s.data("calendar-mode",p),tt="Hour",s.data("calendar-time-mode",tt)),f.reloadData=!0,ut(),a}function ei(){var n=f.date,t;if(p==""?(t=ri(n),d(c,n)):p=="selectmonth"?(t=l.find('.app-scroll-column[data-cal-year="'+n.getFullYear()+'"]'),d(l,n)):p=="selectyear"&&(t=l.find('.app-scroll-column .app-select-year[data-cal-year="'+n.getFullYear()+'"]').parent(),d(l,n)),t.length&&p==k){var r=t.closest(".app-scroll-inner"),u=t.position().left,i=parseInt(r.css("marginLeft"),10),e=i-u;Math.abs(e-i)<5?ut():r.stop().animate({marginLeft:i-u},ut)}else ut()}function oi(){var e=f.event,r=f.target,u=s.data("calendar-onselect"),n=f.date,i=r&&r.closest("td");f.beforeClick&&f.beforeClick(n);i&&i.length&&(n=p==""?t(c):t(l),i&&n.setFullYear(parseInt(i.attr("data-cal-year"),10),parseInt(i.attr("data-cal-month"),10),parseInt(i.attr("data-cal-day"),10)),a.closest(".app-calendar-show-time").length&&ct(y,n));u?u({container:a,monthContainer:c,selectorContainer:l,target:r,event:e,dataView:v,mode:p,timeMode:tt,oldTimeMode:at,showTime:ot,date:n,startField:f.startField,endField:f.endField}):r.closest(".app-month-container").length&&(c.find(".app-selected").removeClass("app-selected"),ni(c,n).addClass("app-selected"));f.date=h=n;kt(y,n,tt)}function si(){v.session("calendar-input-cache",null);delete rt;rt={};f.reloadData=!0;ut()}function hi(){v.session("calendar-input-cache",null);a.removeData();delete rt;rt=null;s.remove()}var s=f.container,g;s.is(".app-calendar-plugin")&&(s=s.parent());var a=s.find(".app-calendar-plugin"),c=a.find(".app-month-container"),l=a.find(".app-date-selector-container"),y=s.find(".app-time-container"),dt=s.find(".app-calendar-action-bar"),k=s.data("calendar-mode"),p=f.mode!=undefined?f.mode:k||"",at=s.data("calendar-time-mode"),tt=f.timeMode||at||"Hour",it=s.data("calendar-show-months")||f.months||1,v=f.dataView||n.dataView(),rt=v.session("calendar-input-cache")||{},yt=s.data("calendar-field"),w=f.field||yt||ti().date,pt=s.data("calendar-limit-start"),et=f.limitStart===undefined?pt:f.limitStart,ot=f.showTime,h=f.date;h&&nt(h)||(h=t(c),ot&&ct(y,h));p!=k&&s.data("calendar-mode",p);tt!=at&&s.data("calendar-time-mode",tt);pt!=et&&s.data("calendar-limit-start",et);yt!=w&&s.data("calendar-field",w);f.months&&s.data("calendar-show-months",f.months);switch(u){case"attach":g=fi();break;case"destroy":g=hi();break;case"refresh":g=ut();break;case"setDate":g=ei();break;case"getDate":g=wt();break;case"click":g=oi();break;case"clearCache":g=si();break;default:$app.alert('Attempted to run CalendarControl("'+u+'").')}return g};nr=function(n,t){this.dataView=n;this.calendar=n.calendar;this.calendars=t};nr.prototype={attach:function(i){var s=this.dataView,f=this,y,h;if(this.calendar||(this.calendar=this.dataView.calendar),this.lastFilter=s.combinedFilter().slice(),!s.get_isTagged("calendar-mini-disabled")){s.get_isTagged("calendar-mini-twomonths")&&(this.showMonths=2);var c=this.calendar?this.calendar.navigateDate||this.calendar.lastDate:null,l=s.calendar.activeCalendar||s.calendar.calendars[Object.keys(s.calendar.calendars)[0]],a=l.date,v=s.extension().commandRow();if(c=v?new Date(v[a.Index]):null,(!c||isNaN(c.getTime()))&&(c=new Date),y=i.find(".app-calendar-plugin").length>0,h=u("attach",{dataView:this.dataView,container:i.find(".ui-panel-inner"),date:c,months:this.showMonths,mode:"",hideActionBar:!0,onselect:function(t){var h=t.target,p=t.container,ut=t.monthContainer,ft=t.selectorContainer,et=t.event,l=t.dataView,ot=t.mode,o=t.date,k=h.closest("table"),c=h.closest("tr"),d=p.find("tr.app-selected"),g=p.find("td.app-selected"),w=c.hasClass("app-selected"),it=h.hasClass("app-selected"),b=$.mobile.activePage.find(".app-wrapper"),nt=b.find(".app-calendar"),a="",tt=nt.length&&nt.is(":visible"),v=l.calendar,s=h,i,y;if(tt){switch(v.mode){case"year":i="Month";s=k.find("tbody tr").filter(function(){return $(this).find("td.app-next-month, td.app-prev-month, th").length<7});break;case"month":w?(i="Week",s=c):(i="Month",s=k.find("tbody tr").filter(function(){return $(this).find("td.app-next-month, td.app-prev-month, th").length<7}));break;case"week":w?i="Day":(i="Week",s=c);break;case"day":it?(i="Week",s=c):i="Day";break;case"agenda":i="Agenda";v.animate=!0;v.enhancePrecision=!0}i=="Week"&&o.setDate(o.getDate()-e[o.getDay()])}else!g.length||h.is(".app-selected")?d.length&&w?a="=":(o.setDate(o.getDate()-e[o.getDay()]),y=new Date(o),y.setDate(o.getDate()+7),y.setSeconds(-1),a="$between$",s=c):a="=";d.add(g).removeClass("app-selected");s.addClass("ui-btn-active app-selected");setTimeout(function(){if(s.removeClass("ui-btn-active"),tt){if(l.calendar.navigateDate=new Date(o),i.toLowerCase()==v.mode)n.presenter("show",{id:l._id,name:"calendar",container:b});else{var t=rt(b.parent().find(".app-bar-header .app-bar-calendar"),r[i]);t&&t.trigger("vclick")}u("refresh",{container:p,dataView:l})}else f.filter(a,o,y)},ei)},onrefresh:function(n){var u=n.container,i=n.monthContainer,o=i.find(".app-scroll-column > div"),p=n.selectorContainer,r=n.dataView,w=n.mode,b=n.date,a=u.find(".app-calendar-plugin-fieldselector"),e=f.getActiveCalendar().date,v=e.Label,s=u.find(".glyphicon-filter"),h=r.combinedFilter(),c=$.mobile.activePage.find(".app-wrapper"),l=c.find(".app-calendar"),y=l.length&&l.is(":visible"),k=r.calendar;a.find(".text").text(v);clearTimeout(sr);sr=setTimeout(function(){var a,v,l,n;if(s.css("opacity","0"),f.filtered=!1,y){if(u.is(":visible")){if(o.find(".app-selected").removeClass("app-selected"),a=r.calendar,v=a.getMostVisibleBlock(c),!v)return;if(l=t(v),n=f.findMonthByDate(i,l),!n||!n.length)return;switch(a.mode){case"year":case"month":n.find("table tr").filter(function(){return $(this).find("td.app-next-month, td.app-prev-month, th").length<7}).addClass("app-selected");break;case"week":f.findDayCell(n,l).parent().addClass("app-selected");break;case"day":f.findDayCell(n,l).addClass("app-selected")}}}else o.find(".app-selected").removeClass("app-selected"),h.length&&$(h).each(function(){var h=this,t,l,n;if(h.startsWith(e.Name)){if(t=/(\w+):(=|\$between\$)(%js%"(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z?)")/.exec(h),!t)return!1;s.css("opacity","1");f.filtered=!0;var u=r.convertStringToFieldValue(e,t[3]),a=f.findMonthByDate(i,u),o=new Date(u),c=t[2]=="=";return(o.setDate(u.getDate()+(c?1:7)),o.setSeconds(-1),l=f.findMonthByDate(i,o),!a.length&&!l.length)?!0:(n=f.findDayCell(i,u).add(f.findDayCell(i,o)),n&&n.length&&(c?n.addClass("app-selected"):n.parent().addClass("app-selected")),!1)}})},450);f.lastFilter=r.combinedFilter().slice()}}),h.addClass("app-show-request"),!y){var b=$('<a class="ui-btn ui-btn-icon-none app-has-droparrow app-calendar-plugin-fieldselector"><span class="glyphicon glyphicon-filter" style="opacity:0"><\/span><span class="text">'+a.Label+"<\/span><\/a>").appendTo(h),p=$('<div class="app-calendar-color-legend"><p class="app-item-desc app-item-desc-before"><\/p><ol><\/ol><\/div>').attr("data-calendar-for",l.name).appendTo(h).hide(),w=$('<a class="ui-btn ui-btn-icon-none app-has-droparrow app-legend-toggle"><\/a>').appendTo(p),k=$('<p class="app-item-desc app-item-desc-after"><\/p>').appendTo(p);$('<span class="app-see-more"><\/span>').text(o.Mobile.More).appendTo(w);$('<span class="app-see-less"><\/span>').text(r.Less).appendTo(w);h.on("show.sidebar.app",function(){var n=h.find(".app-month-container");n.length&&n.find(".app-scroll-inner").css("marginLeft","")})}return h}},refresh:function(){u("refresh",{container:n.sidebar().find(".app-calendar-plugin"),dataView:this.dataView})},getActiveCalendar:function(){return this.calendar?this.calendar.activeCalendar:this.calendars[Object.keys(this.calendars)[0]]},findDayCell:function(n,t){return n.find(String.format('td[data-cal-month="{0}"][data-cal-day="{1}"]:not(.app-day-hidden)',t.getMonth(),t.getDate()))},findMonthByDate:function(n,t){return n.find(String.format('.app-scroll-column > div[data-cal-year="{0}"][data-cal-month="{1}"]',t.getFullYear(),t.getMonth()))},clearCache:function(){u("clearCache",{container:n.sidebar().find(".app-calendar-plugin"),dataView:this.dataView})},filterWithoutField:function(n){var t=this.getActiveCalendar().date.Name;return n.filter(function(n){return!n.startsWith(t)}).join("")},filter:function(t,i,r){var e=this,f=e.dataView,o=e.getActiveCalendar().date,s;f.extension()._instructed=!1;e.filtering=!0;switch(t){case"=":f.applyFieldFilter(o.Index,"=",[i]);break;case"$between$":f.applyFieldFilter(o.Index,"$between",[i,r]);break;case"clear":f.removeFromFilter(o);f.sync()}e.filtering=!1;s=u("refresh",{container:n.sidebar().find(".ui-panel-inner"),dataView:this.dataView})},detach:function(n){wr(n)}};$(document).on("vclick",".app-calendar-color-legend",function(t){var r=$(t.target),ut=n.sidebar(),g,it,o,h,y,rt;if(r.is(".app-calendar-color-legend ol li, .app-calendar-color-legend ol li span")){var ft=n.dataView(),u=ft.calendar,c=u.activeCalendar.colorMap,et=c.getVisibleColors().map(function(n){return c.color(n)}),l=$("body"),t=r.is(".app-event")?r:r.find(".app-event"),p=t.attr("class").match(/app-event-color-(\d+)/),w=l.attr("class").match(/app-event-filter-color-(\d+)/),b=!0;if(p){var k=parseInt(p[1],10),d="app-event-filter-color-"+k,ot=l.is("."+d);if(w&&(g=parseInt(w[1],10),b=et.indexOf(g)!=-1),c.clearFilter(),!ot&&b){l.addClass("app-event-filter "+d);var i=u.scrollable(),f=u.getFirstVisibleBlock(i),st=u.getLastVisibleBlock(i),nt=i.position().top,ht=nt+i.height(),e,a,v=!1,tt=!1;do it=f.find(".app-event.app-event-color-"+k),it.each(function(){var n=$(this),t=n.offset().top;if(t<nt)(u.mode=="month"||!e||e.offset().top<t)&&(e=n);else return t+n.height()>ht?(a=n,v=!0,!1):(tt=!0,v=!0,!1)}),f=f.next();while(!v&&f!=st&&f.length);if(!tt&&(a||e)){o=a||e;switch(u.mode){case"day":case"week":y=o.data("data-context");y&&(rt=y[1],h=s(rt,"find"));break;case"month":case"agenda":h=i.scrollTop()+o.offset().top-i.position().top+(o.height()-i.height())/2}h!=null&&n.animatedScroll(i,h)}}}return!1}if(r.is(".app-legend-toggle, .app-see-more, .app-see-less"))return n.callWithFeedback(r,function(){ut.find(".app-calendar-color-legend").toggleClass("app-see-all")}),!1}).on("vclick",".app-calendar-plugin-fieldselector",function(f){var d=$(f.target),l=d,v=l.closest(".app-calendar-plugin-fieldselector"),e=n.dataView(),o=e.calendarPlugin,h=l.closest(".app-calendar-plugin"),nt=h.data("calendar-mode"),y=h.find(".app-month-container"),tt=h.find(".app-date-selector-container"),it=l.closest("table"),c=[],k,a;o.filtered&&c.push({text:ft.ClearFilter,icon:"delete",callback:function(){o.filter("clear")}},{});$(o.calendars).each(function(){var n=this,t=n.date,i=o.getActiveCalendar().date;c.push({text:t.Label,icon:t==i?"check":"",callback:function(){if(e.calendar.preventNavigate=!0,i!=t){e.removeFromFilter(i);o.calendar.activeCalendar.colorMap.clearFilter();o.calendar.activeCalendar=n;var r=e.viewProp("calendarConfig");r.activeCalendar=n.name;e.viewProp("calendarConfig",r);o.calendar.clear(!0);e.sync()}}})});c.push({},{text:r.Today,icon:"calendar",callback:function(){u("setDate",{container:y.closest(".ui-panel-inner"),date:new Date,dataView:e,reloadData:!0})}});var e=n.dataView(),p=$.mobile.activePage.find(".app-wrapper"),w=p.find(".app-calendar"),g=w.length&&w.is(":visible"),s,b=r.Sync;return g?(h=e.calendar,k=h.getMostVisibleBlock(p),s=t(k)):(a=e.extension().commandRow(),a&&(s=new Date(a[o.getActiveCalendar().date.Index]))),s&&!isNaN(s.getTime())&&(b=String.format("{0} {1}",i.MonthNames[s.getMonth()],s.getFullYear()),c.push({text:b,icon:"recycle",callback:function(){u("setDate",{container:y.closest(".ui-panel-inner"),date:s,dataView:e})}})),n.callWithFeedback(v,function(){n.listPopup({anchor:v,iconPos:"left",items:c})}),!1}).on("touchmove",".app-calendar-plugin, .app-calendar-plugin-container",function(n){if($(n.target).closest("[data-draggable]").length==0)return n.preventDefault(),!1}).on("vclick mousedown",".app-calendar-plugin, .app-calendar-plugin-container",function(r){var b,c,nt,l,vt,k;if(r.preventDefault(),a)return a=!1,!1;if(r.type=="mousedown")return!1;var it=$(r.target),f=it,s=n.dataView(),o=f.closest(".app-calendar-plugin").parent();o.length||(o=f.closest(".app-calendar-plugin-container"));var p=o.data("calendar-mode"),rt=o.find(".app-month-container"),yt=o.find(".app-date-selector-container"),w=o.find(".app-time-container"),ut=f.closest("table"),ft=o.data("calendar-show-months"),d=w.find(".app-time-selector"),v=d.find(".app-time-hand"),e;if(e=p==""?ut.length?t(ut.parent()):t(rt):t(yt),w.length&&ct(w,e),f.is("span.app-current-day")&&(it=f=f.closest("td")),f.is("td")){if(f.is(".app-day-unselectable"))return;if(rt.is(":animated"))return;h("click",{container:o,dataView:s,target:f,event:r})}else if(f.is(".ui-btn-icon-notext"))b=f.is(".app-calendar-plugin-loadleft"),p==""?(b?e.setMonth(e.getMonth()-ft):e.setMonth(e.getMonth()+ft),n.callWithFeedback(f,function(){u("setDate",{container:o,date:e,dataView:s})})):p=="selectmonth"?n.callWithFeedback(f,function(){e.setFullYear(e.getFullYear()+(b?-1:1));u("setDate",{container:o,date:e,dataView:s})}):p=="selectyear"&&n.callWithFeedback(f,function(){e.setFullYear(e.getFullYear()+(b?-12:12));u("setDate",{container:o,date:e,dataView:s})});else if(f.is(".app-month-picker"))n.callWithFeedback(f,function(){u("setDate",{container:o,date:e,mode:"selectmonth",dataView:s})});else if(f.is(".app-year-picker"))p!="selectyear"?(e.setFullYear(e.getFullYear()-5),n.callWithFeedback(f,function(){u("setDate",{container:o,date:e,mode:"selectyear",dataView:s})})):f.removeClass("ui-btn-active");else if(f.is(".app-select-month"))n.callWithFeedback(f,function(){e.setMonth(parseInt(f.attr("data-cal-month"),10));u("setDate",{container:o,date:e,mode:"",reloadData:!0,dataView:s})});else if(f.is(".app-select-year"))n.callWithFeedback(f,function(){e.setFullYear(parseInt(f.attr("data-cal-year"),10));u("setDate",{container:o,date:e,mode:"selectmonth",dataView:s})});else if(f.is(".app-time-hour"))n.callWithFeedback(f),v.removeClass("app-transition"),u("refresh",{container:o,timeMode:"Hour",showTime:!0,dataView:s}),setTimeout(function(){v.addClass("app-transition")}),tt();else if(f.is(".app-time-minute"))n.callWithFeedback(f),v.removeClass("app-transition"),u("refresh",{container:o,timeMode:"Minute",showTime:!0,dataView:s}),setTimeout(function(){v.addClass("app-transition")}),tt();else if(f.closest(".app-time-ampm").length)c=e.getHours(),e.setHours(c+(c<12?12:-12)),lt(w,e),n.callWithFeedback(f),u("click",{container:o,dataView:s,target:f,event:r,date:e,showTime:!0}),tt();else if(f.closest(".app-time-selector").length){e=o.data("select-date")||e;var et=i.AMDesignator=="",ot=d.offset(),pt=o.data("calendar-time-mode"),g=d.height()/2,st=$app.touch.lastTouch()||{x:r.pageX,y:r.pageY},ht=st.x-(g+ot.left),at=st.y-(g+ot.top),wt=et?Math.sqrt(Math.pow(ht,2)+Math.pow(at,2)):0,y=Math.atan2(at,ht)+Math.PI/2;if(y<0&&(y+=Math.PI*2),y/=Math.PI*2,isNaN(y)){console.log("angle is NaN");return}tt();switch(pt){case"Hour":c=Math.round(y*12);et?(nt=wt>g/1.5,nt&&(c+=12),c==24?c=12:c!=12||nt||(c=0)):(c==12&&(c=0),e.getHours()>=12&&(c+=12));e.setHours(c);lt(w,e);u("click",{container:o,dataView:s,target:f,event:r,date:e,showTime:!0,getDateFromInput:!0});v.one("transitionend",function(){v.removeClass("app-transition");u("click",{container:o,dataView:s,target:f,event:r,date:e,showTime:!0,timeMode:"Minute",getDateFromInput:!0});v.addClass("app-transition")});break;case"Minute":l=Math.round(y*60)%60;vt=Math.abs(e.getMinutes()-l);vt>=5&&(k=l%5,k>2?l+=5-k:l-=k);l>=60&&(l=0);e.setMinutes(l);u("click",{container:o,dataView:s,target:f,event:r,date:e,showTime:!0,getDateFromInput:!0})}}else f.is(".app-calendar-btn-ok")?(e=o.data("select-date"),n.callWithFeedback(f,function(){h("setInput",{dataView:s,container:o,date:e});h("hide",{container:o})})):f.is(".app-calendar-btn-cancel")?n.callWithFeedback(f,function(){h("hide",{container:o})}):f.is(".app-calendar-btn-clear")&&n.callWithFeedback(f,function(){h("clear",{dataView:s,container:o});h("hide",{container:o})});return!1}).on("touchstart mousedown pointerdown",".app-calendar-cover",function(n){return n.preventDefault(),h("hide",{container:$(".app-calendar-plugin-container")}),!1}).on("beforefocus.input.app",'[data-input][data-type="date"],[data-input][data-type="datetime"]',function(n){h("attach",{input:n.inputElement})||n.preventDefault()}).on("cancel.input.app",'[data-input][data-type="date"],[data-input][data-type="datetime"]',function(n){$(".app-data-input-helper").is(":visible")&&($(".app-data-input-helper").hide(),n.preventDefault())}).on("help.input.app",'[data-input][data-type="date"],[data-input][data-type="datetime"]',function(n){$(".app-data-input-helper").show();n.preventDefault()});$app.dragMan["calendar-mini"]={start:function(n){n.dir=n.target.closest(".ui-panel").length?"horizontal":"all";this._startX=n.x;this._maxMargin=-n.target.width()*2;this._inner=n.target.find(".app-scroll-inner").stop();this._originalMarginLeft=parseInt(this._inner.css("margin-left")||0,10);this._cancelMarginLeft=this._originalMarginLeft;this._startTime=+new Date},move:function(n){var t=this._originalMarginLeft+n.x-this._startX;t<0&&t>this._maxMargin?this._inner.css("marginLeft",t):(this._startX=n.x,this._originalMarginLeft=parseInt(this._inner.css("margin-left")||0,10))},end:function(n){var s=n.target.closest(".app-calendar-plugin"),i=s.parent(),l=i.data("calendar-show-months"),h=i.data("calendar-mode"),c=i.hasClass("app-calendar-show-time"),e,o,r,f;columns=this._inner.find(".app-scroll-column");columnIndex=0;new Date-this._startTime<200?columnIndex=n.swipeRight?0:2:(e=columns.first().width(),o=-parseInt(this._inner.css("marginLeft"),10),columnIndex=Math.round(o/e));r=columns.eq(columnIndex);f=h==""?t(r.children(":first")):t(r);c&&ct(i.find(".app-time-container"),f);u("setDate",{container:i,date:f});a=!0;setTimeout(function(){a=!1},250)},cancel:function(){this._inner.animate({marginLeft:this._cancelMarginLeft})}};$app.dragMan["calendar-mini-hand"]={start:function(n){n.dir="all";this._startX=n.x;this._startY=n.y;n._timeSelector=n.target.closest(".app-time-selector");n._outerContainer=n._timeSelector.closest(".app-calendar-plugin-container");n._hand=n._timeSelector.find(".app-time-hand").removeClass("app-transition");n._timeSelectorPos=n._timeSelector.offset();n._timeMode=n._outerContainer.data("calendar-time-mode");n._height=n._timeSelector.height()/2;n._is24hour=i.AMDesignator=="";n._date=t(n._outerContainer.find(".app-month-container"))},move:function(n){var e=n.x-(n._height+n._timeSelectorPos.left),o=n.y-(n._height+n._timeSelectorPos.top),s=n._is24hour?Math.sqrt(Math.pow(e,2)+Math.pow(o,2)):0,i=Math.atan2(o,e)+Math.PI/2,t,f,r;i<0&&(i+=Math.PI*2);i/=Math.PI*2;switch(n._timeMode){case"Hour":t=Math.round(i*12);n._is24hour?(f=s>n._height/1.5,f&&(t+=12),t==24?t=12:t!=12||f||(t=0)):t==12&&(t=0);n._date.setHours(t);lt(n.target,n._date);u("refresh",{container:n._outerContainer,date:n._date,showTime:!0});break;case"Minute":r=Math.round(i*60);r==60&&(r=0);n._date.setMinutes(r);u("click",{container:n._outerContainer,date:n._date,target:n.target,showTime:!0})}},end:function(n){n._hand.addClass("app-transition");tt()},cancel:function(n){n._hand.addClass("app-transition")}};tr=function(n,t,i){this.dataView=n;this.calendar=t;this.map=i;this.map||(this.map={});this.count=0;for(var r in this.map)this.map.hasOwnProperty(r)&&this.count++};tr.prototype={color:function(n){if(n==undefined||n==null)return 0;var t=this,i=this.map[n];return typeof i=="undefined"&&(i=this.map[n]=1+this.count%iu,this.count++,t.calendar.color&&(clearTimeout(or),or=setTimeout(function(){t.dataView.viewProp("calendarColorMap-"+t.calendar.color.Name,t.map);t.dataView.calendarPlugin.refresh(!1,!0)},1e3))),i},className:function(n){return"app-event-color-"+this.color(n)},load:function(t){var i=this;clearTimeout(er);er=setTimeout(function(){var h=n.sidebar(),r=h.find(".app-calendar-color-legend"),v=h.find("a.app-legend-toggle"),c=r.find("ol"),u=i.calendar,f=u?u.color:null,l,e,w,a;if(!u||!f||!h.is(":visible")){r.length&&i.hide();return}if(l=f.Label,e=0,t||c.is(":empty")||u.name!=r.attr("data-calendar-for")){var y=i.dataView.calendar.getFirstVisibleBlock(),s=i.getVisibleColors(),p=r.data("calendar-colors")||[];if(!y||!y.hasClass("data-loaded")&&i.dataView.calendar.mode!="agenda")return;if(s.length==p.length&&s.join("")==p.join(""))return;r.data("calendar-colors",s);c.empty();s.forEach(function(n){var r=i.className(n),u=n||o.Data.NullValueInForms,t,f;r&&(t=$("<li><\/li>").text(u),f=$('<span class="app-event">&nbsp;<\/span>').addClass(r).appendTo(t),e++>=lr&&t.addClass("app-hidden"),t.appendTo(c));w=n});r.attr("data-calendar-for",u.name);f.AliasName&&f.AliasName.length&&(a=i.dataView.findField(f.AliasName),a&&(l=a.Label));r.find(".app-item-desc").text(l);e<=lr?v.addClass("app-hidden"):v.removeClass("app-hidden");e!=0&&u.color?r.removeClass("app-hidden"):r.addClass("app-hidden");i.show()}},450)},show:function(){var i=n.sidebar();if(i.is(":visible")&&this.dataView.calendar.mode!="year"){var t=i.find(".app-calendar-color-legend"),r=this.dataView.calendar.scrollable(),u=r.find(".app-calendar"),f=!t.is(":visible");!t.is(".app-hidden")&&u.is(":visible")&&t.find("ol li").length?f&&t.show():this.hide()}},hide:function(){var t=n.sidebar(),i=t.find(".app-calendar-color-legend");i.hide()},getVisibleColors:function(){var f=[],r=this.dataView.calendar,h=r.scrollable(),n=r.getFirstVisibleBlock(h),p=r.getLastVisibleBlock(h),e=r.mode=="agenda",c=e?r.activeCalendar.color.AliasName||r.activeCalendar.color.Name:3,i,l,u,a,v,o,y,s;if(r.mode!="year")while(n&&n.length){if(i=n.data("calendar-colors"),!i&&(n.hasClass("data-loaded")||e)){if(i=[],l=t(n),e)a=n.find(".app-event"),a.each(function(){var t=$(this).data("data-context"),n=t[c];i.indexOf(n)==-1&&i.push(n)});else{u=r.cache.select(l);for(v in u){o=u[v].rows||u.rows;for(y in o)s=o[y][c],i.indexOf(s)==-1&&i.push(s);if(r.mode.match(/day|week/))break}}n.data("calendar-colors",i)}if(i&&i.forEach(function(n){f.indexOf(n)==-1&&f.push(n)}),n[0]==p[0])break;n=n.next()}return f.sort()},clearFilter:function(){for(var t=[],n=0;n<=23;n++)t.push("app-event-filter app-event-filter-color-"+n);$("body").removeClass(t.join(" "))}}}(),function(){var r=!$app.touch.desktop(),n=window,u=$(n),i=$(window.body),f=i.is(".app-ios");$app.input.methods.richtext={extend:function(n){var u=this,i=n.inner,f=n.row,r=n.field;if(v=f[r.Index],t=v==null?resources.NullValueInForms:r.format(v),i.html(t),r.Rows&&i.height(r.Rows+"em"),n.editing)i.on("blur",function(){u.blur(i)})},focus:function(n){var t=n.position();n.attr("contentEditable","true").addClass("app-rich-text-editor")},blur:function(n){n.removeAttr("contentEditable").removeClass("app-rich-text-editor")}}}();